<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!-- git web interface version 1.7.3.GIT, (C) 2005-2006, Kay Sievers <kay.sievers@vrfy.org>, Christian Gierke -->
<!-- git core binaries version 1.7.4.1 -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="generator" content="gitweb/1.7.3.GIT git/1.7.4.1"/>
<meta name="robots" content="index, nofollow"/>
<title>drupalcode.org Git - sandbox/sumsi/1074206.git/blob - vote.module</title>
<base href="http://drupalcode.org" />
<link rel="stylesheet" type="text/css" href="/gitweb.css"/>
<link rel="stylesheet" type="text/css" href="/highlight.css"/>
<link rel="alternate" title="sandbox/sumsi/1074206.git - history of vote.module - RSS feed" href="http://drupalcode.org/sandbox/sumsi/1074206.git/rss?f=vote.module" type="application/rss+xml" />
<link rel="alternate" title="sandbox/sumsi/1074206.git - history of vote.module - RSS feed (no merges)" href="http://drupalcode.org/sandbox/sumsi/1074206.git/rss?f=vote.module;opt=--no-merges" type="application/rss+xml" />
<link rel="alternate" title="sandbox/sumsi/1074206.git - history of vote.module - Atom feed" href="http://drupalcode.org/sandbox/sumsi/1074206.git/atom?f=vote.module;opt=--no-merges" type="application/atom+xml" />
<link rel="alternate" title="sandbox/sumsi/1074206.git - history of vote.module - Atom feed (no merges)" href="http://drupalcode.org/sandbox/sumsi/1074206.git/atom?f=vote.module;opt=--no-merges" type="application/atom+xml" />
<link rel="shortcut icon" href="/git-favicon.png" type="image/png" />
</head>
<body>
<div class="page_header">
<a title="git homepage" href="http://drupal.org/"><img src="/git-logo.png" width="72" height="27" alt="git" class="logo"/></a><a href="/">projects</a> / <a href="http://drupalcode.org/sandbox/sumsi/1074206.git">sandbox/sumsi/1074206.git</a> / blob
</div>
<form method="get" action="http://drupalcode.org/sandbox/sumsi/1074206.git" enctype="application/x-www-form-urlencoded">
<div class="search">
<input name="a" type="hidden" value="search" />
<input name="h" type="hidden" value="HEAD" />
<select name="st" >
<option selected="selected" value="commit">commit</option>
<option value="grep">grep</option>
<option value="author">author</option>
<option value="committer">committer</option>
<option value="pickaxe">pickaxe</option>
</select><sup><a href="http://drupalcode.org/sandbox/sumsi/1074206.git/search_help">?</a></sup> search:
<input type="text" name="s"  />
<span title="Extended regular expression"><label><input type="checkbox" name="sr" value="1" />re</label></span></div>
</form>
<div class="page_nav">
<a href="http://drupalcode.org/sandbox/sumsi/1074206.git">summary</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/shortlog">shortlog</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/log">log</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/commit/HEAD">commit</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/commitdiff/HEAD">commitdiff</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/tree/HEAD">tree</a><br/>
<a href="http://drupalcode.org/sandbox/sumsi/1074206.git/blame/HEAD:/vote.module">blame</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/history/HEAD:/vote.module">history</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob_plain/HEAD:/vote.module">raw</a> | <a href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module">HEAD</a><br/>
</div>
<div class="header">
<a class="title" href="http://drupalcode.org/sandbox/sumsi/1074206.git/commit/HEAD">Rethinking bundles.</a>
</div>
<div class="page_path"><a title="tree root" href="http://drupalcode.org/sandbox/sumsi/1074206.git/tree/HEAD">[sandbox/sumsi/1074206.git]</a> / <a title="vote.module" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob_plain/HEAD:/vote.module">vote.module</a><br/></div>
<div class="page_body">
<div class="pre"><a id="l1" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l1" class="linenr">   1</a> <span class="hl sym">&lt;</span>?php</div>
<div class="pre"><a id="l2" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l2" class="linenr">   2</a> </div>
<div class="pre"><a id="l3" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l3" class="linenr">   3</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l4" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l4" class="linenr">   4</a> <span class="hl com"> * &#64;file</span></div>
<div class="pre"><a id="l5" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l5" class="linenr">   5</a> <span class="hl com"> * Defines a vote and vote result API that can be used by other modules.</span></div>
<div class="pre"><a id="l6" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l6" class="linenr">   6</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l7" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l7" class="linenr">   7</a> </div>
<div class="pre"><a id="l8" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l8" class="linenr">   8</a> <span class="hl com">/*</span></div>
<div class="pre"><a id="l9" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l9" class="linenr">   9</a> <span class="hl com"> * Implements hook_cron_queue_info().</span></div>
<div class="pre"><a id="l10" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l10" class="linenr">  10</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l11" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l11" class="linenr">  11</a> <span class="hl com"> * The cron queue caches the results for vote constellations that have been</span></div>
<div class="pre"><a id="l12" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l12" class="linenr">  12</a> <span class="hl com"> * queued for recalculation.</span></div>
<div class="pre"><a id="l13" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l13" class="linenr">  13</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l14" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l14" class="linenr">  14</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_cron_queue_info</span><span class="hl sym">() {</span></div>
<div class="pre"><a id="l15" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l15" class="linenr">  15</a>   <span class="hl kwd">module_load_include</span><span class="hl sym">(</span><span class="hl str">'inc'</span><span class="hl sym">,</span> <span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'includes/vote.queue'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l16" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l16" class="linenr">  16</a> </div>
<div class="pre"><a id="l17" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l17" class="linenr">  17</a>   <span class="hl kwa">return array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l18" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l18" class="linenr">  18</a>     <span class="hl str">'vote_queue'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l19" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l19" class="linenr">  19</a>       <span class="hl str">'worker callback'</span> <span class="hl sym">=&gt;</span> <span class="hl str">'vote_result_cache_results'</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l20" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l20" class="linenr">  20</a>       <span class="hl str">'time'</span> <span class="hl sym">=&gt;</span> <span class="hl num">60</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l21" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l21" class="linenr">  21</a>     <span class="hl sym">),</span></div>
<div class="pre"><a id="l22" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l22" class="linenr">  22</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l23" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l23" class="linenr">  23</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l24" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l24" class="linenr">  24</a> </div>
<div class="pre"><a id="l25" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l25" class="linenr">  25</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l26" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l26" class="linenr">  26</a> <span class="hl com"> * Implements hook_exit().</span></div>
<div class="pre"><a id="l27" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l27" class="linenr">  27</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l28" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l28" class="linenr">  28</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_exit</span><span class="hl sym">() {</span></div>
<div class="pre"><a id="l29" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l29" class="linenr">  29</a>   <span class="hl kwd">module_load_include</span><span class="hl sym">(</span><span class="hl str">'inc'</span><span class="hl sym">,</span> <span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'includes/vote.queue'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l30" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l30" class="linenr">  30</a> </div>
<div class="pre"><a id="l31" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l31" class="linenr">  31</a>   <span class="hl kwc">$queue</span> <span class="hl sym">=</span> DrupalQueue<span class="hl sym">::</span><span class="hl kwd">get</span><span class="hl sym">(</span><span class="hl str">'vote_static_queue'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l32" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l32" class="linenr">  32</a> </div>
<div class="pre"><a id="l33" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l33" class="linenr">  33</a>   <span class="hl kwa">while</span> <span class="hl sym">(</span><span class="hl kwc">$item</span> <span class="hl sym">=</span> <span class="hl kwc">$queue</span><span class="hl sym">-&gt;</span><span class="hl kwd">claimItem</span><span class="hl sym">()) {</span></div>
<div class="pre"><a id="l34" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l34" class="linenr">  34</a>     <span class="hl kwd">vote_result_cache_results</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>data<span class="hl sym">);</span></div>
<div class="pre"><a id="l35" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l35" class="linenr">  35</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l36" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l36" class="linenr">  36</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l37" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l37" class="linenr">  37</a> </div>
<div class="pre"><a id="l38" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l38" class="linenr">  38</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l39" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l39" class="linenr">  39</a> <span class="hl com"> * Implements hook_entity_delete().</span></div>
<div class="pre"><a id="l40" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l40" class="linenr">  40</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l41" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l41" class="linenr">  41</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_entity_delete</span><span class="hl sym">(</span><span class="hl kwc">$entity</span><span class="hl sym">,</span> <span class="hl kwc">$type</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l42" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l42" class="linenr">  42</a>   <span class="hl slc">// An entity has been deleted so lets delete all associated votes and</span></div>
<div class="pre"><a id="l43" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l43" class="linenr">  43</a>   <span class="hl slc">// results as well. We don't need to remove items from the queue</span></div>
<div class="pre"><a id="l44" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l44" class="linenr">  44</a>   <span class="hl slc">// as they won't do any harm anyways and will be removed on cron.</span></div>
<div class="pre"><a id="l45" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l45" class="linenr">  45</a>   <span class="hl kwa">list</span><span class="hl sym">(</span><span class="hl kwc">$id</span><span class="hl sym">) =</span> <span class="hl kwd">entity_extract_ids</span><span class="hl sym">(</span><span class="hl kwc">$type</span><span class="hl sym">,</span> <span class="hl kwc">$entity</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l46" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l46" class="linenr">  46</a> </div>
<div class="pre"><a id="l47" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l47" class="linenr">  47</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l48" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l48" class="linenr">  48</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_type'</span><span class="hl sym">,</span> <span class="hl kwc">$type</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l49" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l49" class="linenr">  49</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_id'</span><span class="hl sym">,</span> <span class="hl kwc">$id</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l50" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l50" class="linenr">  50</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l51" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l51" class="linenr">  51</a> </div>
<div class="pre"><a id="l52" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l52" class="linenr">  52</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l53" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l53" class="linenr">  53</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_type'</span><span class="hl sym">,</span> <span class="hl kwc">$type</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l54" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l54" class="linenr">  54</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_id'</span><span class="hl sym">,</span> <span class="hl kwc">$id</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l55" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l55" class="linenr">  55</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l56" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l56" class="linenr">  56</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l57" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l57" class="linenr">  57</a> </div>
<div class="pre"><a id="l58" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l58" class="linenr">  58</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l59" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l59" class="linenr">  59</a> <span class="hl com"> * Implements hook_user_cancel().</span></div>
<div class="pre"><a id="l60" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l60" class="linenr">  60</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l61" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l61" class="linenr">  61</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_user_cancel</span><span class="hl sym">(</span><span class="hl kwc">$edit</span><span class="hl sym">,</span> <span class="hl kwc">$account</span><span class="hl sym">,</span> <span class="hl kwc">$method</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l62" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l62" class="linenr">  62</a>   <span class="hl kwa">switch</span> <span class="hl sym">(</span><span class="hl kwc">$method</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l63" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l63" class="linenr">  63</a>     case <span class="hl str">'user_cancel_delete'</span><span class="hl sym">:</span></div>
<div class="pre"><a id="l64" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l64" class="linenr">  64</a>       <span class="hl slc">// Delete all votes and queue their constellations.</span></div>
<div class="pre"><a id="l65" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l65" class="linenr">  65</a>       <span class="hl kwd">module_load_include</span><span class="hl sym">(</span><span class="hl str">'inc'</span><span class="hl sym">,</span> <span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'includes/vote.admin'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l66" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l66" class="linenr">  66</a> </div>
<div class="pre"><a id="l67" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l67" class="linenr">  67</a>       <span class="hl kwc">$votes</span> <span class="hl sym">=</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'v'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l68" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l68" class="linenr">  68</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'v'</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'entity_type'</span><span class="hl sym">,</span> <span class="hl str">'entity_id'</span><span class="hl sym">,</span> <span class="hl str">'bundle'</span><span class="hl sym">,</span> <span class="hl str">'aggregate'</span><span class="hl sym">))</span></div>
<div class="pre"><a id="l69" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l69" class="linenr">  69</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'uid'</span><span class="hl sym">,</span> <span class="hl kwc">$account</span><span class="hl sym">-&gt;</span>uid<span class="hl sym">)</span></div>
<div class="pre"><a id="l70" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l70" class="linenr">  70</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l71" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l71" class="linenr">  71</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">fetchAll</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l72" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l72" class="linenr">  72</a> </div>
<div class="pre"><a id="l73" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l73" class="linenr">  73</a>       <span class="hl kwd">vote_mass_queue</span><span class="hl sym">(</span><span class="hl kwc">$votes</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l74" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l74" class="linenr">  74</a>       <span class="hl kwa">break</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l75" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l75" class="linenr">  75</a> </div>
<div class="pre"><a id="l76" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l76" class="linenr">  76</a>     case <span class="hl str">'user_cancel_reassign'</span><span class="hl sym">:</span></div>
<div class="pre"><a id="l77" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l77" class="linenr">  77</a>       <span class="hl slc">// Anonymize votes.</span></div>
<div class="pre"><a id="l78" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l78" class="linenr">  78</a>       <span class="hl kwd">module_load_include</span><span class="hl sym">(</span><span class="hl str">'inc'</span><span class="hl sym">,</span> <span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'includes/vote.admin'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l79" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l79" class="linenr">  79</a> </div>
<div class="pre"><a id="l80" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l80" class="linenr">  80</a>       <span class="hl kwc">$votes</span> <span class="hl sym">=</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'v'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l81" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l81" class="linenr">  81</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'v'</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'vid'</span><span class="hl sym">))</span></div>
<div class="pre"><a id="l82" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l82" class="linenr">  82</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'uid'</span><span class="hl sym">,</span> <span class="hl kwc">$account</span><span class="hl sym">-&gt;</span>uid<span class="hl sym">)</span></div>
<div class="pre"><a id="l83" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l83" class="linenr">  83</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l84" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l84" class="linenr">  84</a>         <span class="hl sym">-&gt;</span><span class="hl kwd">fetchCol</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l85" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l85" class="linenr">  85</a> </div>
<div class="pre"><a id="l86" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l86" class="linenr">  86</a>       <span class="hl kwd">vote_mass_update</span><span class="hl sym">(</span><span class="hl kwc">$votes</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'uid'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l87" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l87" class="linenr">  87</a>       <span class="hl kwa">break</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l88" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l88" class="linenr">  88</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l89" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l89" class="linenr">  89</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l90" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l90" class="linenr">  90</a> </div>
<div class="pre"><a id="l91" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l91" class="linenr">  91</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l92" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l92" class="linenr">  92</a> <span class="hl com"> * Stores and returns vote result function information. Vote result functions</span></div>
<div class="pre"><a id="l93" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l93" class="linenr">  93</a> <span class="hl com"> * can be assigned to value types and are return multi-delta or single result</span></div>
<div class="pre"><a id="l94" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l94" class="linenr">  94</a> <span class="hl com"> * values for a voting pool and target. Examples for vote result functions are</span></div>
<div class="pre"><a id="l95" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l95" class="linenr">  95</a> <span class="hl com"> * &quot;Average&quot;, &quot;Sum&quot; or &quot;Count&quot;.</span></div>
<div class="pre"><a id="l96" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l96" class="linenr">  96</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l97" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l97" class="linenr">  97</a> <span class="hl com"> * &#64;param $name (optional)</span></div>
<div class="pre"><a id="l98" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l98" class="linenr">  98</a> <span class="hl com"> *   The name of an existing function.</span></div>
<div class="pre"><a id="l99" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l99" class="linenr">  99</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l100" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l100" class="linenr"> 100</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l101" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l101" class="linenr"> 101</a> <span class="hl com"> *   An array containing all available vote result functions or one</span></div>
<div class="pre"><a id="l102" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l102" class="linenr"> 102</a> <span class="hl com"> *   single vote result function.</span></div>
<div class="pre"><a id="l103" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l103" class="linenr"> 103</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l104" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l104" class="linenr"> 104</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_function_info</span><span class="hl sym">(</span><span class="hl kwc">$name</span> <span class="hl sym">=</span> NULL<span class="hl sym">) {</span></div>
<div class="pre"><a id="l105" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l105" class="linenr"> 105</a>   <span class="hl kwc">$functions</span> <span class="hl sym">= &amp;</span><span class="hl kwd">drupal_static</span><span class="hl sym">(</span>__FUNCTION__<span class="hl sym">);</span></div>
<div class="pre"><a id="l106" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l106" class="linenr"> 106</a> </div>
<div class="pre"><a id="l107" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l107" class="linenr"> 107</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$functions</span><span class="hl sym">) &amp;&amp;</span> <span class="hl kwc">$cache</span> <span class="hl sym">=</span> <span class="hl kwd">cache_get</span><span class="hl sym">(</span><span class="hl str">'vote_functions'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l108" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l108" class="linenr"> 108</a>     <span class="hl kwc">$functions</span> <span class="hl sym">=</span> <span class="hl kwc">$cache</span><span class="hl sym">-&gt;</span>data<span class="hl sym">;</span></div>
<div class="pre"><a id="l109" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l109" class="linenr"> 109</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l110" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l110" class="linenr"> 110</a> </div>
<div class="pre"><a id="l111" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l111" class="linenr"> 111</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$functions</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l112" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l112" class="linenr"> 112</a>     <span class="hl kwc">$defaults</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l113" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l113" class="linenr"> 113</a>       <span class="hl str">'label'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l114" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l114" class="linenr"> 114</a>       <span class="hl str">'description'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l115" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l115" class="linenr"> 115</a>       <span class="hl str">'recalculation callback'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l116" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l116" class="linenr"> 116</a>     <span class="hl sym">);</span></div>
<div class="pre"><a id="l117" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l117" class="linenr"> 117</a> </div>
<div class="pre"><a id="l118" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l118" class="linenr"> 118</a>     <span class="hl slc">// Collect vote result function information from modules.</span></div>
<div class="pre"><a id="l119" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l119" class="linenr"> 119</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwd">module_implements</span><span class="hl sym">(</span><span class="hl str">'vote_function_info'</span><span class="hl sym">)</span> as <span class="hl kwc">$module</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l120" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l120" class="linenr"> 120</a>       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> <span class="hl sym">=</span> <span class="hl kwd">module_invoke</span><span class="hl sym">(</span><span class="hl kwc">$module</span><span class="hl sym">,</span> <span class="hl str">'vote_function_info'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l121" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l121" class="linenr"> 121</a>         <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> as <span class="hl kwc">$type</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$info</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l122" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l122" class="linenr"> 122</a>           <span class="hl kwc">$functions</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">] =</span> <span class="hl kwc">$info</span> <span class="hl sym">+</span> <span class="hl kwc">$defaults</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l123" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l123" class="linenr"> 123</a>           <span class="hl kwc">$functions</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">][</span><span class="hl str">'module'</span><span class="hl sym">] =</span> <span class="hl kwc">$module</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l124" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l124" class="linenr"> 124</a>           <span class="hl kwc">$functions</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">][</span><span class="hl str">'type'</span><span class="hl sym">] =</span> <span class="hl kwc">$type</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l125" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l125" class="linenr"> 125</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l126" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l126" class="linenr"> 126</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l127" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l127" class="linenr"> 127</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l128" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l128" class="linenr"> 128</a> </div>
<div class="pre"><a id="l129" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l129" class="linenr"> 129</a>     <span class="hl slc">// Give modules a chance to alter the vote result functions array.</span></div>
<div class="pre"><a id="l130" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l130" class="linenr"> 130</a>     <span class="hl kwd">drupal_alter</span><span class="hl sym">(</span><span class="hl str">'vote_function_info'</span><span class="hl sym">,</span> <span class="hl kwc">$functions</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l131" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l131" class="linenr"> 131</a> </div>
<div class="pre"><a id="l132" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l132" class="linenr"> 132</a>     <span class="hl slc">// Cache the gathered information in the database.</span></div>
<div class="pre"><a id="l133" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l133" class="linenr"> 133</a>     <span class="hl kwd">cache_set</span><span class="hl sym">(</span><span class="hl str">'vote_functions'</span><span class="hl sym">,</span> <span class="hl kwc">$functions</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l134" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l134" class="linenr"> 134</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l135" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l135" class="linenr"> 135</a> </div>
<div class="pre"><a id="l136" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l136" class="linenr"> 136</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">) &amp;&amp;</span> <span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$functions</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l137" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l137" class="linenr"> 137</a>     <span class="hl slc">// Return one single function if $name is set.</span></div>
<div class="pre"><a id="l138" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l138" class="linenr"> 138</a>     <span class="hl kwa">return</span> <span class="hl kwc">$functions</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">];</span></div>
<div class="pre"><a id="l139" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l139" class="linenr"> 139</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l140" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l140" class="linenr"> 140</a>   <span class="hl kwa">elseif</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l141" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l141" class="linenr"> 141</a>     <span class="hl slc">// Return an array containing all functions if $name is not set.</span></div>
<div class="pre"><a id="l142" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l142" class="linenr"> 142</a>     <span class="hl kwa">return</span> <span class="hl kwc">$functions</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l143" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l143" class="linenr"> 143</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l144" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l144" class="linenr"> 144</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l145" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l145" class="linenr"> 145</a> </div>
<div class="pre"><a id="l146" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l146" class="linenr"> 146</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l147" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l147" class="linenr"> 147</a> <span class="hl com"> * Stores and returns vote value type information. Each pool has exactly one</span></div>
<div class="pre"><a id="l148" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l148" class="linenr"> 148</a> <span class="hl com"> * value type and the available vote result functions and other vote and vote</span></div>
<div class="pre"><a id="l149" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l149" class="linenr"> 149</a> <span class="hl com"> * result behaviors are specific to the value type in some cases. Examples</span></div>
<div class="pre"><a id="l150" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l150" class="linenr"> 150</a> <span class="hl com"> * for value types are &quot;Percent&quot; or &quot;Points&quot;. The value type describes how</span></div>
<div class="pre"><a id="l151" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l151" class="linenr"> 151</a> <span class="hl com"> * the vote and vote results need to be handled.</span></div>
<div class="pre"><a id="l152" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l152" class="linenr"> 152</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l153" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l153" class="linenr"> 153</a> <span class="hl com"> * &#64;param $name (optional)</span></div>
<div class="pre"><a id="l154" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l154" class="linenr"> 154</a> <span class="hl com"> *   The name of an existing value type.</span></div>
<div class="pre"><a id="l155" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l155" class="linenr"> 155</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l156" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l156" class="linenr"> 156</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l157" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l157" class="linenr"> 157</a> <span class="hl com"> *   An array containing all available vote value types or one single</span></div>
<div class="pre"><a id="l158" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l158" class="linenr"> 158</a> <span class="hl com"> *   value type.</span></div>
<div class="pre"><a id="l159" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l159" class="linenr"> 159</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l160" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l160" class="linenr"> 160</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$name</span> <span class="hl sym">=</span> NULL<span class="hl sym">) {</span></div>
<div class="pre"><a id="l161" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l161" class="linenr"> 161</a>   <span class="hl kwc">$types</span> <span class="hl sym">= &amp;</span><span class="hl kwd">drupal_static</span><span class="hl sym">(</span>__FUNCTION__<span class="hl sym">);</span></div>
<div class="pre"><a id="l162" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l162" class="linenr"> 162</a> </div>
<div class="pre"><a id="l163" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l163" class="linenr"> 163</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$types</span><span class="hl sym">) &amp;&amp;</span> <span class="hl kwc">$cache</span> <span class="hl sym">=</span> <span class="hl kwd">cache_get</span><span class="hl sym">(</span><span class="hl str">'vote_types'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l164" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l164" class="linenr"> 164</a>     <span class="hl kwc">$types</span> <span class="hl sym">=</span> <span class="hl kwc">$cache</span><span class="hl sym">-&gt;</span>data<span class="hl sym">;</span></div>
<div class="pre"><a id="l165" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l165" class="linenr"> 165</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l166" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l166" class="linenr"> 166</a> </div>
<div class="pre"><a id="l167" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l167" class="linenr"> 167</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$types</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l168" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l168" class="linenr"> 168</a>     <span class="hl kwc">$defaults</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l169" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l169" class="linenr"> 169</a>       <span class="hl str">'label'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l170" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l170" class="linenr"> 170</a>       <span class="hl str">'description'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l171" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l171" class="linenr"> 171</a>       <span class="hl str">'functions'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">array</span><span class="hl sym">(),</span></div>
<div class="pre"><a id="l172" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l172" class="linenr"> 172</a>       <span class="hl str">'recalculation callback'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l173" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l173" class="linenr"> 173</a>     <span class="hl sym">);</span></div>
<div class="pre"><a id="l174" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l174" class="linenr"> 174</a> </div>
<div class="pre"><a id="l175" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l175" class="linenr"> 175</a>     <span class="hl slc">// Collect vote value type information from modules.</span></div>
<div class="pre"><a id="l176" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l176" class="linenr"> 176</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwd">module_implements</span><span class="hl sym">(</span><span class="hl str">'vote_type_info'</span><span class="hl sym">)</span> as <span class="hl kwc">$module</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l177" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l177" class="linenr"> 177</a>       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> <span class="hl sym">=</span> <span class="hl kwd">module_invoke</span><span class="hl sym">(</span><span class="hl kwc">$module</span><span class="hl sym">,</span> <span class="hl str">'vote_type_info'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l178" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l178" class="linenr"> 178</a>         <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> as <span class="hl kwc">$type</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$info</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l179" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l179" class="linenr"> 179</a>           <span class="hl kwc">$types</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">] =</span> <span class="hl kwc">$info</span> <span class="hl sym">+</span> <span class="hl kwc">$defaults</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l180" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l180" class="linenr"> 180</a>           <span class="hl kwc">$types</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">][</span><span class="hl str">'module'</span><span class="hl sym">] =</span> <span class="hl kwc">$module</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l181" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l181" class="linenr"> 181</a>           <span class="hl kwc">$types</span><span class="hl sym">[</span><span class="hl kwc">$type</span><span class="hl sym">][</span><span class="hl str">'type'</span><span class="hl sym">] =</span> <span class="hl kwc">$type</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l182" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l182" class="linenr"> 182</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l183" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l183" class="linenr"> 183</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l184" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l184" class="linenr"> 184</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l185" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l185" class="linenr"> 185</a> </div>
<div class="pre"><a id="l186" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l186" class="linenr"> 186</a>     <span class="hl slc">// Give modules a chance to alter the value type array.</span></div>
<div class="pre"><a id="l187" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l187" class="linenr"> 187</a>     <span class="hl kwd">drupal_alter</span><span class="hl sym">(</span><span class="hl str">'vote_type_info'</span><span class="hl sym">,</span> <span class="hl kwc">$types</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l188" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l188" class="linenr"> 188</a> </div>
<div class="pre"><a id="l189" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l189" class="linenr"> 189</a>     <span class="hl slc">// Cache the gathered information in the database.</span></div>
<div class="pre"><a id="l190" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l190" class="linenr"> 190</a>     <span class="hl kwd">cache_set</span><span class="hl sym">(</span><span class="hl str">'vote_types'</span><span class="hl sym">,</span> <span class="hl kwc">$types</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l191" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l191" class="linenr"> 191</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l192" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l192" class="linenr"> 192</a> </div>
<div class="pre"><a id="l193" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l193" class="linenr"> 193</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">) &amp;&amp;</span> <span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$types</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l194" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l194" class="linenr"> 194</a>     <span class="hl slc">// Return one single value type if $name is set.</span></div>
<div class="pre"><a id="l195" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l195" class="linenr"> 195</a>     <span class="hl kwa">return</span> <span class="hl kwc">$types</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">];</span></div>
<div class="pre"><a id="l196" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l196" class="linenr"> 196</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l197" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l197" class="linenr"> 197</a>   <span class="hl kwa">elseif</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l198" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l198" class="linenr"> 198</a>     <span class="hl slc">// Return an array containing all value types if $name is not set.</span></div>
<div class="pre"><a id="l199" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l199" class="linenr"> 199</a>     <span class="hl kwa">return</span> <span class="hl kwc">$types</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l200" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l200" class="linenr"> 200</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l201" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l201" class="linenr"> 201</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l202" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l202" class="linenr"> 202</a> </div>
<div class="pre"><a id="l203" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l203" class="linenr"> 203</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l204" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l204" class="linenr"> 204</a> <span class="hl com"> * Save changes to a vote or create a new vote.</span></div>
<div class="pre"><a id="l205" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l205" class="linenr"> 205</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l206" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l206" class="linenr"> 206</a> <span class="hl com"> * &#64;param $vote</span></div>
<div class="pre"><a id="l207" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l207" class="linenr"> 207</a> <span class="hl com"> *   The $vote object to be saved. If $vote-&gt;vid is omitted a new vote will</span></div>
<div class="pre"><a id="l208" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l208" class="linenr"> 208</a> <span class="hl com"> *   be added.</span></div>
<div class="pre"><a id="l209" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l209" class="linenr"> 209</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l210" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l210" class="linenr"> 210</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_save</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l211" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l211" class="linenr"> 211</a>   <span class="hl slc">// Add the proper timestamps to the $vote object.</span></div>
<div class="pre"><a id="l212" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l212" class="linenr"> 212</a>   <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>created <span class="hl sym">=</span> <span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>vid<span class="hl sym">) &amp;&amp;</span> <span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>created<span class="hl sym">)</span> ? REQUEST_TIME <span class="hl sym">:</span> <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>created<span class="hl sym">;</span></div>
<div class="pre"><a id="l213" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l213" class="linenr"> 213</a>   <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>changed <span class="hl sym">=</span> REQUEST_TIME<span class="hl sym">;</span></div>
<div class="pre"><a id="l214" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l214" class="linenr"> 214</a> </div>
<div class="pre"><a id="l215" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l215" class="linenr"> 215</a>   <span class="hl slc">// Determine the proper $operation for this vote object (insert or update).</span></div>
<div class="pre"><a id="l216" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l216" class="linenr"> 216</a>   <span class="hl kwc">$operation</span> <span class="hl sym">=</span> <span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>vid<span class="hl sym">)</span> ? <span class="hl str">'insert'</span> <span class="hl sym">:</span> <span class="hl str">'update'</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l217" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l217" class="linenr"> 217</a> </div>
<div class="pre"><a id="l218" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l218" class="linenr"> 218</a>   <span class="hl slc">// Build the intersection of the passed $vote object and the actual field schema.</span></div>
<div class="pre"><a id="l219" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l219" class="linenr"> 219</a>   <span class="hl kwc">$fields</span> <span class="hl sym">=</span> <span class="hl kwd">array_intersect_key</span><span class="hl sym">((</span><span class="hl kwa">array</span><span class="hl sym">)</span> <span class="hl kwc">$vote</span><span class="hl sym">,</span> <span class="hl kwa">array_flip</span><span class="hl sym">(</span><span class="hl kwd">drupal_schema_fields_sql</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)));</span></div>
<div class="pre"><a id="l220" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l220" class="linenr"> 220</a> </div>
<div class="pre"><a id="l221" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l221" class="linenr"> 221</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$operation</span> <span class="hl sym">==</span> <span class="hl str">'update'</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l222" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l222" class="linenr"> 222</a>     <span class="hl slc">// Update an existing vote.</span></div>
<div class="pre"><a id="l223" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l223" class="linenr"> 223</a>     <span class="hl slc">// We don't need to update the primary key and the timestamp.</span></div>
<div class="pre"><a id="l224" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l224" class="linenr"> 224</a>     <span class="hl kwa">unset</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">[</span><span class="hl str">'vid'</span><span class="hl sym">],</span> <span class="hl kwc">$fields</span><span class="hl sym">[</span><span class="hl str">'created'</span><span class="hl sym">]);</span></div>
<div class="pre"><a id="l225" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l225" class="linenr"> 225</a> </div>
<div class="pre"><a id="l226" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l226" class="linenr"> 226</a>     <span class="hl kwd">db_update</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l227" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l227" class="linenr"> 227</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l228" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l228" class="linenr"> 228</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'vid'</span><span class="hl sym">,</span> <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>vid<span class="hl sym">)</span></div>
<div class="pre"><a id="l229" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l229" class="linenr"> 229</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l230" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l230" class="linenr"> 230</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l231" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l231" class="linenr"> 231</a>   <span class="hl kwa">else</span> <span class="hl sym">{</span></div>
<div class="pre"><a id="l232" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l232" class="linenr"> 232</a>     <span class="hl slc">// Save a new vote to the database.</span></div>
<div class="pre"><a id="l233" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l233" class="linenr"> 233</a>     <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>vid <span class="hl sym">=</span> <span class="hl kwd">db_insert</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'return'</span> <span class="hl sym">=&gt;</span> Database<span class="hl sym">::</span>RETURN_INSERT_ID<span class="hl sym">))</span></div>
<div class="pre"><a id="l234" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l234" class="linenr"> 234</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l235" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l235" class="linenr"> 235</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l236" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l236" class="linenr"> 236</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l237" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l237" class="linenr"> 237</a> </div>
<div class="pre"><a id="l238" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l238" class="linenr"> 238</a> </div>
<div class="pre"><a id="l239" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l239" class="linenr"> 239</a>   <span class="hl slc">// Process the vote.</span></div>
<div class="pre"><a id="l240" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l240" class="linenr"> 240</a>   <span class="hl kwd">vote_queue</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l241" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l241" class="linenr"> 241</a> </div>
<div class="pre"><a id="l242" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l242" class="linenr"> 242</a>   <span class="hl slc">// Invoke module hooks.</span></div>
<div class="pre"><a id="l243" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l243" class="linenr"> 243</a>   <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_'</span> . <span class="hl kwc">$operation</span><span class="hl sym">,</span> <span class="hl kwc">$vote</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l244" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l244" class="linenr"> 244</a> </div>
<div class="pre"><a id="l245" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l245" class="linenr"> 245</a>   <span class="hl kwa">return</span> <span class="hl kwc">$vote</span><span class="hl sym">-&gt;</span>vid<span class="hl sym">;</span></div>
<div class="pre"><a id="l246" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l246" class="linenr"> 246</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l247" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l247" class="linenr"> 247</a> </div>
<div class="pre"><a id="l248" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l248" class="linenr"> 248</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l249" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l249" class="linenr"> 249</a> <span class="hl com"> * Deletes a single vote.</span></div>
<div class="pre"><a id="l250" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l250" class="linenr"> 250</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l251" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l251" class="linenr"> 251</a> <span class="hl com"> * &#64;param $vid</span></div>
<div class="pre"><a id="l252" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l252" class="linenr"> 252</a> <span class="hl com"> *   A vote id.</span></div>
<div class="pre"><a id="l253" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l253" class="linenr"> 253</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l254" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l254" class="linenr"> 254</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_delete</span><span class="hl sym">(</span><span class="hl kwc">$vid</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l255" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l255" class="linenr"> 255</a>   <span class="hl kwd">vote_delete_multiple</span><span class="hl sym">(</span><span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl kwc">$vid</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l256" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l256" class="linenr"> 256</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l257" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l257" class="linenr"> 257</a> </div>
<div class="pre"><a id="l258" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l258" class="linenr"> 258</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l259" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l259" class="linenr"> 259</a> <span class="hl com"> * Deletes a set of votes.</span></div>
<div class="pre"><a id="l260" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l260" class="linenr"> 260</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l261" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l261" class="linenr"> 261</a> <span class="hl com"> * &#64;param $vids</span></div>
<div class="pre"><a id="l262" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l262" class="linenr"> 262</a> <span class="hl com"> *   An array of vote ids.</span></div>
<div class="pre"><a id="l263" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l263" class="linenr"> 263</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l264" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l264" class="linenr"> 264</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_delete_multiple</span><span class="hl sym">(</span><span class="hl kwc">$vids</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l265" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l265" class="linenr"> 265</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$votes</span> <span class="hl sym">=</span> <span class="hl kwd">vote_load_multiple</span><span class="hl sym">(</span><span class="hl kwc">$vids</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l266" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l266" class="linenr"> 266</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$votes</span> as <span class="hl kwc">$vote</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l267" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l267" class="linenr"> 267</a>       <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_delete'</span><span class="hl sym">,</span> <span class="hl kwc">$vote</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l268" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l268" class="linenr"> 268</a> </div>
<div class="pre"><a id="l269" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l269" class="linenr"> 269</a>       <span class="hl kwd">vote_queue</span><span class="hl sym">(</span><span class="hl kwc">$vote</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l270" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l270" class="linenr"> 270</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l271" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l271" class="linenr"> 271</a> </div>
<div class="pre"><a id="l272" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l272" class="linenr"> 272</a>     <span class="hl slc">// Delete after calling hooks so that they can query vote tables as needed.</span></div>
<div class="pre"><a id="l273" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l273" class="linenr"> 273</a>     <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l274" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l274" class="linenr"> 274</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'vid'</span><span class="hl sym">,</span> <span class="hl kwc">$vids</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l275" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l275" class="linenr"> 275</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l276" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l276" class="linenr"> 276</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l277" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l277" class="linenr"> 277</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l278" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l278" class="linenr"> 278</a> </div>
<div class="pre"><a id="l279" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l279" class="linenr"> 279</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l280" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l280" class="linenr"> 280</a> <span class="hl com"> * Loads a vote as stdClass Object.</span></div>
<div class="pre"><a id="l281" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l281" class="linenr"> 281</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l282" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l282" class="linenr"> 282</a> <span class="hl com"> * &#64;param $vid</span></div>
<div class="pre"><a id="l283" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l283" class="linenr"> 283</a> <span class="hl com"> *   The vid of the vote you want to load.</span></div>
<div class="pre"><a id="l284" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l284" class="linenr"> 284</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l285" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l285" class="linenr"> 285</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l286" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l286" class="linenr"> 286</a> <span class="hl com"> *   A vote as stdClass Object or FALSE if the vid doesn't exist.</span></div>
<div class="pre"><a id="l287" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l287" class="linenr"> 287</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l288" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l288" class="linenr"> 288</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_load</span><span class="hl sym">(</span><span class="hl kwc">$vid</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l289" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l289" class="linenr"> 289</a>   <span class="hl kwc">$votes</span> <span class="hl sym">=</span> <span class="hl kwd">vote_load_multiple</span><span class="hl sym">(</span><span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl kwc">$vid</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l290" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l290" class="linenr"> 290</a> </div>
<div class="pre"><a id="l291" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l291" class="linenr"> 291</a>   <span class="hl kwa">return</span> <span class="hl sym">!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$votes</span><span class="hl sym">)</span> ? <span class="hl kwa">reset</span><span class="hl sym">(</span><span class="hl kwc">$votes</span><span class="hl sym">) :</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l292" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l292" class="linenr"> 292</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l293" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l293" class="linenr"> 293</a> </div>
<div class="pre"><a id="l294" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l294" class="linenr"> 294</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l295" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l295" class="linenr"> 295</a> <span class="hl com"> * Loads multiple votes.</span></div>
<div class="pre"><a id="l296" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l296" class="linenr"> 296</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l297" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l297" class="linenr"> 297</a> <span class="hl com"> * &#64;param $vids</span></div>
<div class="pre"><a id="l298" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l298" class="linenr"> 298</a> <span class="hl com"> *   An array of vids. Leave empty if you want to fetch by condition.</span></div>
<div class="pre"><a id="l299" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l299" class="linenr"> 299</a> <span class="hl com"> * &#64;param $conditions</span></div>
<div class="pre"><a id="l300" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l300" class="linenr"> 300</a> <span class="hl com"> *   An array of conditions. Leave empty if you want to fetch by vid.</span></div>
<div class="pre"><a id="l301" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l301" class="linenr"> 301</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l302" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l302" class="linenr"> 302</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l303" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l303" class="linenr"> 303</a> <span class="hl com"> *   An array of votes as stdClass Objects.</span></div>
<div class="pre"><a id="l304" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l304" class="linenr"> 304</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l305" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l305" class="linenr"> 305</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_load_multiple</span><span class="hl sym">(</span><span class="hl kwc">$vids</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(),</span> <span class="hl kwc">$conditions</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">()) {</span></div>
<div class="pre"><a id="l306" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l306" class="linenr"> 306</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$vids</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l307" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l307" class="linenr"> 307</a>     <span class="hl kwa">return</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'v'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l308" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l308" class="linenr"> 308</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'v'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l309" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l309" class="linenr"> 309</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'vid'</span><span class="hl sym">,</span> <span class="hl kwc">$vid</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l310" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l310" class="linenr"> 310</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l311" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l311" class="linenr"> 311</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fetchAll</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l312" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l312" class="linenr"> 312</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l313" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l313" class="linenr"> 313</a>   <span class="hl kwa">else if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$conditions</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l314" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l314" class="linenr"> 314</a>     <span class="hl kwc">$conditions</span> <span class="hl sym">=</span> <span class="hl kwd">array_intersect_key</span><span class="hl sym">((</span><span class="hl kwa">array</span><span class="hl sym">)</span> <span class="hl kwc">$vote</span><span class="hl sym">,</span> <span class="hl kwa">array_flip</span><span class="hl sym">(</span><span class="hl kwd">drupal_schema_fields_sql</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)));</span></div>
<div class="pre"><a id="l315" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l315" class="linenr"> 315</a>     <span class="hl kwc">$query</span> <span class="hl sym">=</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'v'</span><span class="hl sym">)-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'v'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l316" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l316" class="linenr"> 316</a> </div>
<div class="pre"><a id="l317" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l317" class="linenr"> 317</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$conditions</span> as <span class="hl kwc">$key</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$value</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l318" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l318" class="linenr"> 318</a>       <span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl kwc">$key</span><span class="hl sym">,</span> <span class="hl kwc">$value</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l319" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l319" class="linenr"> 319</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l320" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l320" class="linenr"> 320</a> </div>
<div class="pre"><a id="l321" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l321" class="linenr"> 321</a>     <span class="hl kwa">return</span> <span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()-&gt;</span><span class="hl kwd">fetchAll</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l322" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l322" class="linenr"> 322</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l323" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l323" class="linenr"> 323</a> </div>
<div class="pre"><a id="l324" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l324" class="linenr"> 324</a>   <span class="hl kwa">return</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l325" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l325" class="linenr"> 325</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l326" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l326" class="linenr"> 326</a> </div>
<div class="pre"><a id="l327" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l327" class="linenr"> 327</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l328" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l328" class="linenr"> 328</a> <span class="hl com"> * Caches the results of a voting.</span></div>
<div class="pre"><a id="l329" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l329" class="linenr"> 329</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l330" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l330" class="linenr"> 330</a> <span class="hl com"> * &#64;param $item</span></div>
<div class="pre"><a id="l331" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l331" class="linenr"> 331</a> <span class="hl com"> *   A pool-target constellation containing th  e machine-readable pool name</span></div>
<div class="pre"><a id="l332" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l332" class="linenr"> 332</a> <span class="hl com"> *   as well as the entity id and the entity type of the target.</span></div>
<div class="pre"><a id="l333" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l333" class="linenr"> 333</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l334" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l334" class="linenr"> 334</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_result_cache_results</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l335" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l335" class="linenr"> 335</a>   <span class="hl slc">// Populate the $item-&gt;functions with the proper functions array.</span></div>
<div class="pre"><a id="l336" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l336" class="linenr"> 336</a>   <span class="hl kwc">$bundle</span> <span class="hl sym">=</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate ? <span class="hl kwd">vote_aggregate_get_aggregate</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">) :</span> <span class="hl kwd">vote_pool_get_pool</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">);</span></div>
<div class="pre"><a id="l337" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l337" class="linenr"> 337</a> </div>
<div class="pre"><a id="l338" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l338" class="linenr"> 338</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$bundle</span> <span class="hl sym">&amp;&amp; !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$bundle</span><span class="hl sym">-&gt;</span>functions<span class="hl sym">) &amp;&amp; (!</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate <span class="hl sym">|| !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$bundle</span><span class="hl sym">-&gt;</span>pools<span class="hl sym">))) {</span></div>
<div class="pre"><a id="l339" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l339" class="linenr"> 339</a>     <span class="hl slc">// Delete all old results for this constellation so we don't end up with</span></div>
<div class="pre"><a id="l340" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l340" class="linenr"> 340</a>     <span class="hl slc">// ghost results.</span></div>
<div class="pre"><a id="l341" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l341" class="linenr"> 341</a>     <span class="hl kwc">$query</span> <span class="hl sym">=</span> <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l342" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l342" class="linenr"> 342</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_type'</span><span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">)</span></div>
<div class="pre"><a id="l343" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l343" class="linenr"> 343</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'entity_id'</span><span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">)</span></div>
<div class="pre"><a id="l344" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l344" class="linenr"> 344</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'bundle'</span><span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">)</span></div>
<div class="pre"><a id="l345" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l345" class="linenr"> 345</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'aggregate'</span><span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">)</span></div>
<div class="pre"><a id="l346" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l346" class="linenr"> 346</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'function'</span><span class="hl sym">,</span> <span class="hl kwc">$bundle</span><span class="hl sym">-&gt;</span>functions<span class="hl sym">);</span></div>
<div class="pre"><a id="l347" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l347" class="linenr"> 347</a> </div>
<div class="pre"><a id="l348" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l348" class="linenr"> 348</a>     <span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l349" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l349" class="linenr"> 349</a> </div>
<div class="pre"><a id="l350" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l350" class="linenr"> 350</a>     <span class="hl kwc">$pools</span> <span class="hl sym">=</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate ? <span class="hl kwc">$bundle</span><span class="hl sym">-&gt;</span>pools <span class="hl sym">:</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">;</span></div>
<div class="pre"><a id="l351" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l351" class="linenr"> 351</a> </div>
<div class="pre"><a id="l352" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l352" class="linenr"> 352</a>     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$results</span> <span class="hl sym">=</span> <span class="hl kwd">vote_result_recalculate_results</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">,</span> <span class="hl kwc">$bundle</span><span class="hl sym">-&gt;</span>functions<span class="hl sym">,</span> <span class="hl kwc">$pools</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l353" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l353" class="linenr"> 353</a>       <span class="hl slc">// Looks like we have an array of results so let's save them.</span></div>
<div class="pre"><a id="l354" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l354" class="linenr"> 354</a>       <span class="hl kwc">$query</span> <span class="hl sym">=</span> <span class="hl kwd">db_insert</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">)-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwd">drupal_schema_fields_sql</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l355" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l355" class="linenr"> 355</a> </div>
<div class="pre"><a id="l356" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l356" class="linenr"> 356</a>       <span class="hl slc">// The $result array is already pre-formatted in the right order. So we</span></div>
<div class="pre"><a id="l357" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l357" class="linenr"> 357</a>       <span class="hl slc">// can just add it safely.</span></div>
<div class="pre"><a id="l358" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l358" class="linenr"> 358</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$results</span> as <span class="hl kwc">$result</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l359" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l359" class="linenr"> 359</a>         <span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">values</span><span class="hl sym">(</span><span class="hl kwa">array_values</span><span class="hl sym">(</span><span class="hl kwc">$result</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l360" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l360" class="linenr"> 360</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l361" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l361" class="linenr"> 361</a> </div>
<div class="pre"><a id="l362" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l362" class="linenr"> 362</a>       <span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l363" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l363" class="linenr"> 363</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l364" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l364" class="linenr"> 364</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l365" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l365" class="linenr"> 365</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l366" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l366" class="linenr"> 366</a> </div>
<div class="pre"><a id="l367" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l367" class="linenr"> 367</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l368" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l368" class="linenr"> 368</a> <span class="hl com"> * &#64;param $item</span></div>
<div class="pre"><a id="l369" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l369" class="linenr"> 369</a> <span class="hl com"> *   A pool-target constellation containing the machine-readable pool name</span></div>
<div class="pre"><a id="l370" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l370" class="linenr"> 370</a> <span class="hl com"> *   as well as the entity id and the entity type of the target.</span></div>
<div class="pre"><a id="l371" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l371" class="linenr"> 371</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l372" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l372" class="linenr"> 372</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l373" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l373" class="linenr"> 373</a> <span class="hl com"> *   An array of results or FALSE if there are no votes.</span></div>
<div class="pre"><a id="l374" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l374" class="linenr"> 374</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l375" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l375" class="linenr"> 375</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_result_recalculate_results</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">,</span> <span class="hl kwc">$functions</span><span class="hl sym">,</span> <span class="hl kwc">$pools</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l376" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l376" class="linenr"> 376</a>   <span class="hl kwc">$results</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l377" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l377" class="linenr"> 377</a> </div>
<div class="pre"><a id="l378" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l378" class="linenr"> 378</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$functions</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l379" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l379" class="linenr"> 379</a>     <span class="hl slc">// Iterate over all functions and invoke the recalculation callbacks.</span></div>
<div class="pre"><a id="l380" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l380" class="linenr"> 380</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$functions</span> as <span class="hl kwc">$function</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l381" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l381" class="linenr"> 381</a>       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$info</span> <span class="hl sym">=</span> <span class="hl kwd">vote_function_info</span><span class="hl sym">(</span><span class="hl kwc">$function</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l382" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l382" class="linenr"> 382</a>         <span class="hl kwc">$callback</span> <span class="hl sym">=</span> <span class="hl kwc">$info</span><span class="hl sym">[</span><span class="hl str">'recalculation callback'</span><span class="hl sym">];</span></div>
<div class="pre"><a id="l383" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l383" class="linenr"> 383</a> </div>
<div class="pre"><a id="l384" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l384" class="linenr"> 384</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwa">function_exists</span><span class="hl sym">(</span><span class="hl kwc">$callback</span><span class="hl sym">) &amp;&amp;</span> <span class="hl kwc">$result</span> <span class="hl sym">=</span> <span class="hl kwc">$callback</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">,</span> <span class="hl kwc">$function</span><span class="hl sym">,</span> <span class="hl kwc">$pools</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l385" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l385" class="linenr"> 385</a>           <span class="hl slc">// If this function returns an array we use the keys of that array as</span></div>
<div class="pre"><a id="l386" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l386" class="linenr"> 386</a>           <span class="hl slc">// result value deltas.</span></div>
<div class="pre"><a id="l387" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l387" class="linenr"> 387</a>           <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwa">is_array</span><span class="hl sym">(</span><span class="hl kwc">$result</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l388" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l388" class="linenr"> 388</a>             <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$result</span> as <span class="hl kwc">$delta</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$value</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l389" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l389" class="linenr"> 389</a>               <span class="hl kwc">$current</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l390" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l390" class="linenr"> 390</a>                 <span class="hl str">'result'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$value</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l391" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l391" class="linenr"> 391</a>                 <span class="hl str">'delta'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$delta</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l392" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l392" class="linenr"> 392</a>                 <span class="hl str">'function'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$function</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l393" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l393" class="linenr"> 393</a>                 <span class="hl str">'bundle'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">,</span></div>
<div class="pre"><a id="l394" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l394" class="linenr"> 394</a>                 <span class="hl str">'aggregate'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">,</span></div>
<div class="pre"><a id="l395" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l395" class="linenr"> 395</a>                 <span class="hl str">'entity_type'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span></div>
<div class="pre"><a id="l396" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l396" class="linenr"> 396</a>                 <span class="hl str">'entity_id'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span></div>
<div class="pre"><a id="l397" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l397" class="linenr"> 397</a>                 <span class="hl str">'timestamp'</span> <span class="hl sym">=&gt;</span> REQUEST_TIME<span class="hl sym">,</span></div>
<div class="pre"><a id="l398" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l398" class="linenr"> 398</a>               <span class="hl sym">);</span></div>
<div class="pre"><a id="l399" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l399" class="linenr"> 399</a> </div>
<div class="pre"><a id="l400" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l400" class="linenr"> 400</a>               <span class="hl kwc">$key</span> <span class="hl sym">=</span> <span class="hl kwd">vote_result_key</span><span class="hl sym">((</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$current</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l401" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l401" class="linenr"> 401</a> </div>
<div class="pre"><a id="l402" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l402" class="linenr"> 402</a>               <span class="hl kwa">array_push</span><span class="hl sym">(</span><span class="hl kwc">$results</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'rid'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$key</span><span class="hl sym">) +</span> <span class="hl kwc">$current</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l403" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l403" class="linenr"> 403</a>             <span class="hl sym">}</span></div>
<div class="pre"><a id="l404" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l404" class="linenr"> 404</a>           <span class="hl sym">}</span></div>
<div class="pre"><a id="l405" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l405" class="linenr"> 405</a>           <span class="hl slc">// Otherwise we handle this as a single result value.</span></div>
<div class="pre"><a id="l406" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l406" class="linenr"> 406</a>           <span class="hl kwa">else</span> <span class="hl sym">{</span></div>
<div class="pre"><a id="l407" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l407" class="linenr"> 407</a>             <span class="hl kwc">$current</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l408" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l408" class="linenr"> 408</a>               <span class="hl str">'result'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$result</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l409" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l409" class="linenr"> 409</a>               <span class="hl str">'delta'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l410" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l410" class="linenr"> 410</a>               <span class="hl str">'function'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$function</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l411" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l411" class="linenr"> 411</a>               <span class="hl str">'bundle'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">,</span></div>
<div class="pre"><a id="l412" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l412" class="linenr"> 412</a>               <span class="hl str">'aggregate'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">,</span></div>
<div class="pre"><a id="l413" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l413" class="linenr"> 413</a>               <span class="hl str">'entity_type'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span></div>
<div class="pre"><a id="l414" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l414" class="linenr"> 414</a>               <span class="hl str">'entity_id'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span></div>
<div class="pre"><a id="l415" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l415" class="linenr"> 415</a>               <span class="hl str">'timestamp'</span> <span class="hl sym">=&gt;</span> REQUEST_TIME<span class="hl sym">,</span></div>
<div class="pre"><a id="l416" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l416" class="linenr"> 416</a>             <span class="hl sym">);</span></div>
<div class="pre"><a id="l417" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l417" class="linenr"> 417</a> </div>
<div class="pre"><a id="l418" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l418" class="linenr"> 418</a>             <span class="hl kwc">$key</span> <span class="hl sym">=</span> <span class="hl kwd">vote_result_key</span><span class="hl sym">((</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$current</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l419" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l419" class="linenr"> 419</a> </div>
<div class="pre"><a id="l420" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l420" class="linenr"> 420</a>             <span class="hl kwa">array_push</span><span class="hl sym">(</span><span class="hl kwc">$results</span><span class="hl sym">,</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl str">'rid'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$key</span><span class="hl sym">) +</span> <span class="hl kwc">$current</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l421" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l421" class="linenr"> 421</a>           <span class="hl sym">}</span></div>
<div class="pre"><a id="l422" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l422" class="linenr"> 422</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l423" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l423" class="linenr"> 423</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l424" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l424" class="linenr"> 424</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l425" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l425" class="linenr"> 425</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l426" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l426" class="linenr"> 426</a> </div>
<div class="pre"><a id="l427" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l427" class="linenr"> 427</a>   <span class="hl kwa">return</span> <span class="hl kwc">$results</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l428" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l428" class="linenr"> 428</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l429" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l429" class="linenr"> 429</a> </div>
<div class="pre"><a id="l430" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l430" class="linenr"> 430</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l431" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l431" class="linenr"> 431</a> <span class="hl com"> * Queues a constellation for recalculation. We have two different queues. One</span></div>
<div class="pre"><a id="l432" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l432" class="linenr"> 432</a> <span class="hl com"> * has a Database Backend and is reserved for Cron and one saves the queued</span></div>
<div class="pre"><a id="l433" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l433" class="linenr"> 433</a> <span class="hl com"> * items in a static variable that we loop over in hook_exit().</span></div>
<div class="pre"><a id="l434" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l434" class="linenr"> 434</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l435" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l435" class="linenr"> 435</a> <span class="hl com"> * &#64;param $item</span></div>
<div class="pre"><a id="l436" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l436" class="linenr"> 436</a> <span class="hl com"> *   A full object.</span></div>
<div class="pre"><a id="l437" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l437" class="linenr"> 437</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l438" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l438" class="linenr"> 438</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_queue</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l439" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l439" class="linenr"> 439</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$info</span> <span class="hl sym">=</span> <span class="hl kwd">vote_pool_get_pool</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">)) {</span></div>
<div class="pre"><a id="l440" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l440" class="linenr"> 440</a>     <span class="hl kwd">module_load_include</span><span class="hl sym">(</span><span class="hl str">'inc'</span><span class="hl sym">,</span> <span class="hl str">'vote'</span><span class="hl sym">,</span> <span class="hl str">'includes/vote.queue'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l441" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l441" class="linenr"> 441</a> </div>
<div class="pre"><a id="l442" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l442" class="linenr"> 442</a>     <span class="hl kwc">$queue</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l443" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l443" class="linenr"> 443</a>       <span class="hl str">'bundle'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">,</span></div>
<div class="pre"><a id="l444" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l444" class="linenr"> 444</a>       <span class="hl str">'aggregate'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> FALSE<span class="hl sym">,</span></div>
<div class="pre"><a id="l445" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l445" class="linenr"> 445</a>       <span class="hl str">'entity_type'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span></div>
<div class="pre"><a id="l446" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l446" class="linenr"> 446</a>       <span class="hl str">'entity_id'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span></div>
<div class="pre"><a id="l447" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l447" class="linenr"> 447</a>     <span class="hl sym">);</span></div>
<div class="pre"><a id="l448" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l448" class="linenr"> 448</a> </div>
<div class="pre"><a id="l449" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l449" class="linenr"> 449</a>     DrupalQueue<span class="hl sym">::</span><span class="hl kwd">get</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">-&gt;</span>queue<span class="hl sym">)-&gt;</span><span class="hl kwd">createItem</span><span class="hl sym">((</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$queue</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l450" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l450" class="linenr"> 450</a> </div>
<div class="pre"><a id="l451" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l451" class="linenr"> 451</a>     <span class="hl slc">// Now we queue the aggregates (if there are any).</span></div>
<div class="pre"><a id="l452" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l452" class="linenr"> 452</a>     <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">-&gt;</span>aggregates<span class="hl sym">)) {</span></div>
<div class="pre"><a id="l453" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l453" class="linenr"> 453</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">-&gt;</span>aggregates as <span class="hl kwc">$name</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l454" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l454" class="linenr"> 454</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$aggregate</span> <span class="hl sym">=</span> <span class="hl kwd">vote_aggregate_get_aggregate</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l455" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l455" class="linenr"> 455</a>           <span class="hl kwc">$queue</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l456" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l456" class="linenr"> 456</a>             <span class="hl str">'bundle'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$name</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l457" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l457" class="linenr"> 457</a>             <span class="hl str">'aggregate'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> TRUE<span class="hl sym">,</span></div>
<div class="pre"><a id="l458" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l458" class="linenr"> 458</a>             <span class="hl str">'entity_type'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span></div>
<div class="pre"><a id="l459" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l459" class="linenr"> 459</a>             <span class="hl str">'entity_id'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span></div>
<div class="pre"><a id="l460" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l460" class="linenr"> 460</a>           <span class="hl sym">);</span></div>
<div class="pre"><a id="l461" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l461" class="linenr"> 461</a> </div>
<div class="pre"><a id="l462" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l462" class="linenr"> 462</a>           DrupalQueue<span class="hl sym">::</span><span class="hl kwd">get</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>queue<span class="hl sym">)-&gt;</span><span class="hl kwd">createItem</span><span class="hl sym">((</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$queue</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l463" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l463" class="linenr"> 463</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l464" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l464" class="linenr"> 464</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l465" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l465" class="linenr"> 465</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l466" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l466" class="linenr"> 466</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l467" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l467" class="linenr"> 467</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l468" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l468" class="linenr"> 468</a> </div>
<div class="pre"><a id="l469" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l469" class="linenr"> 469</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l470" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l470" class="linenr"> 470</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l471" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l471" class="linenr"> 471</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l472" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l472" class="linenr"> 472</a> <span class="hl kwa">function</span> <span class="hl kwd">_vote_bundles_build</span><span class="hl sym">(</span><span class="hl kwc">$rebuild</span> <span class="hl sym">=</span> FALSE<span class="hl sym">) {</span></div>
<div class="pre"><a id="l473" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l473" class="linenr"> 473</a>   <span class="hl kwc">$cache</span> <span class="hl sym">= &amp;</span><span class="hl kwd">drupal_static</span><span class="hl sym">(</span>__FUNCTION__<span class="hl sym">);</span></div>
<div class="pre"><a id="l474" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l474" class="linenr"> 474</a> </div>
<div class="pre"><a id="l475" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l475" class="linenr"> 475</a>   <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$cache</span><span class="hl sym">) ||</span> <span class="hl kwc">$rebuild</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l476" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l476" class="linenr"> 476</a>     <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwc">$rebuild</span> <span class="hl sym">&amp;&amp;</span> <span class="hl kwc">$cache</span> <span class="hl sym">=</span> <span class="hl kwd">cache_get</span><span class="hl sym">(</span><span class="hl str">'vote_bundles'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l477" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l477" class="linenr"> 477</a>       <span class="hl kwa">return</span> <span class="hl kwc">$cache</span> <span class="hl sym">=</span> <span class="hl kwc">$cache</span><span class="hl sym">-&gt;</span>data<span class="hl sym">;</span></div>
<div class="pre"><a id="l478" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l478" class="linenr"> 478</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l479" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l479" class="linenr"> 479</a> </div>
<div class="pre"><a id="l480" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l480" class="linenr"> 480</a>     <span class="hl kwc">$pools</span> <span class="hl sym">=</span> <span class="hl kwd">_vote_pool_info_build</span><span class="hl sym">(</span><span class="hl kwc">$rebuild</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l481" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l481" class="linenr"> 481</a>     <span class="hl kwc">$aggregates</span> <span class="hl sym">=</span> <span class="hl kwd">_vote_aggregate_info_build</span><span class="hl sym">(</span><span class="hl kwc">$rebuild</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l482" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l482" class="linenr"> 482</a> </div>
<div class="pre"><a id="l483" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l483" class="linenr"> 483</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$pools</span> as <span class="hl kwc">$name</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l484" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l484" class="linenr"> 484</a>       <span class="hl kwc">$info</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>type<span class="hl sym">);</span></div>
<div class="pre"><a id="l485" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l485" class="linenr"> 485</a>       <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>aggregates <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l486" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l486" class="linenr"> 486</a>       <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>functions <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l487" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l487" class="linenr"> 487</a>       <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>queue <span class="hl sym">= !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">[</span><span class="hl str">'queue'</span><span class="hl sym">])</span> ? <span class="hl str">'vote_queue'</span> <span class="hl sym">:</span> <span class="hl str">'vote_static_queue'</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l488" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l488" class="linenr"> 488</a> </div>
<div class="pre"><a id="l489" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l489" class="linenr"> 489</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">]</span> as <span class="hl kwc">$function</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l490" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l490" class="linenr"> 490</a>         <span class="hl slc">// Create a list of all enabled and available functions.</span></div>
<div class="pre"><a id="l491" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l491" class="linenr"> 491</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwa">in_array</span><span class="hl sym">(</span><span class="hl kwc">$function</span><span class="hl sym">,</span> <span class="hl kwc">$info</span><span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">]) &amp;&amp;</span> <span class="hl kwd">vote_function_info</span><span class="hl sym">(</span><span class="hl kwc">$function</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l492" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l492" class="linenr"> 492</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>functions<span class="hl sym">[] =</span> <span class="hl kwc">$function</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l493" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l493" class="linenr"> 493</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l494" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l494" class="linenr"> 494</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l495" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l495" class="linenr"> 495</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l496" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l496" class="linenr"> 496</a> </div>
<div class="pre"><a id="l497" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l497" class="linenr"> 497</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$aggregates</span> as <span class="hl kwc">$name</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l498" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l498" class="linenr"> 498</a>       <span class="hl kwc">$info</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>type<span class="hl sym">);</span></div>
<div class="pre"><a id="l499" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l499" class="linenr"> 499</a>       <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>pools <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l500" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l500" class="linenr"> 500</a>       <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>functions <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l501" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l501" class="linenr"> 501</a>       <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>queue <span class="hl sym">= !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">[</span><span class="hl str">'queue'</span><span class="hl sym">])</span> ? <span class="hl str">'vote_queue'</span> <span class="hl sym">:</span> <span class="hl str">'vote_static_queue'</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l502" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l502" class="linenr"> 502</a> </div>
<div class="pre"><a id="l503" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l503" class="linenr"> 503</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">]</span> as <span class="hl kwc">$function</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l504" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l504" class="linenr"> 504</a>         <span class="hl slc">// Create a list of all enabled and available functions.</span></div>
<div class="pre"><a id="l505" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l505" class="linenr"> 505</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwa">in_array</span><span class="hl sym">(</span><span class="hl kwc">$function</span><span class="hl sym">,</span> <span class="hl kwc">$info</span><span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">]) &amp;&amp;</span> <span class="hl kwd">vote_function_info</span><span class="hl sym">(</span><span class="hl kwc">$function</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l506" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l506" class="linenr"> 506</a>           <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>functions<span class="hl sym">[] =</span> <span class="hl kwc">$function</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l507" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l507" class="linenr"> 507</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l508" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l508" class="linenr"> 508</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l509" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l509" class="linenr"> 509</a> </div>
<div class="pre"><a id="l510" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l510" class="linenr"> 510</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">[</span><span class="hl str">'pools'</span><span class="hl sym">]</span> as <span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l511" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l511" class="linenr"> 511</a>         <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]) &amp;&amp;</span> <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]-&gt;</span>type <span class="hl sym">==</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>type<span class="hl sym">) {</span></div>
<div class="pre"><a id="l512" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l512" class="linenr"> 512</a>           <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$name</span><span class="hl sym">]-&gt;</span>pools<span class="hl sym">[] =</span> <span class="hl kwc">$pool</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l513" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l513" class="linenr"> 513</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]-&gt;</span>aggregates<span class="hl sym">[] =</span> <span class="hl kwc">$name</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l514" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l514" class="linenr"> 514</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l515" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l515" class="linenr"> 515</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l516" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l516" class="linenr"> 516</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l517" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l517" class="linenr"> 517</a> </div>
<div class="pre"><a id="l518" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l518" class="linenr"> 518</a>     <span class="hl kwc">$cache</span> <span class="hl sym">= (</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l519" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l519" class="linenr"> 519</a>       <span class="hl str">'pools'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$pools</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l520" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l520" class="linenr"> 520</a>       <span class="hl str">'aggregates'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$aggregates</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l521" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l521" class="linenr"> 521</a>     <span class="hl sym">);</span></div>
<div class="pre"><a id="l522" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l522" class="linenr"> 522</a> </div>
<div class="pre"><a id="l523" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l523" class="linenr"> 523</a>     <span class="hl slc">// Cache the bundles</span></div>
<div class="pre"><a id="l524" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l524" class="linenr"> 524</a>     <span class="hl kwd">cache_set</span><span class="hl sym">(</span><span class="hl str">'vote_bundles'</span><span class="hl sym">,</span> <span class="hl kwc">$cache</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l525" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l525" class="linenr"> 525</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l526" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l526" class="linenr"> 526</a> </div>
<div class="pre"><a id="l527" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l527" class="linenr"> 527</a>   <span class="hl kwa">return</span> <span class="hl kwc">$cache</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l528" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l528" class="linenr"> 528</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l529" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l529" class="linenr"> 529</a> </div>
<div class="pre"><a id="l530" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l530" class="linenr"> 530</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l531" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l531" class="linenr"> 531</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l532" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l532" class="linenr"> 532</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l533" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l533" class="linenr"> 533</a> <span class="hl kwa">function</span> <span class="hl kwd">_vote_pool_info_build</span><span class="hl sym">(</span><span class="hl kwc">$rebuild</span> <span class="hl sym">=</span> FALSE<span class="hl sym">) {</span></div>
<div class="pre"><a id="l534" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l534" class="linenr"> 534</a>   <span class="hl kwc">$pools</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l535" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l535" class="linenr"> 535</a> </div>
<div class="pre"><a id="l536" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l536" class="linenr"> 536</a>   <span class="hl slc">// Collect module defined vote pools.</span></div>
<div class="pre"><a id="l537" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l537" class="linenr"> 537</a>   <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwd">module_implements</span><span class="hl sym">(</span><span class="hl str">'vote_pool_info'</span><span class="hl sym">)</span> as <span class="hl kwc">$module</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l538" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l538" class="linenr"> 538</a>     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> <span class="hl sym">=</span> <span class="hl kwd">module_invoke</span><span class="hl sym">(</span><span class="hl kwc">$module</span><span class="hl sym">,</span> <span class="hl str">'vote_pool_info'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l539" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l539" class="linenr"> 539</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> as <span class="hl kwc">$pool</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$info</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l540" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l540" class="linenr"> 540</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$type</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">[</span><span class="hl str">'type'</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l541" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l541" class="linenr"> 541</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">] =</span> <span class="hl kwd">vote_pool_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l542" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l542" class="linenr"> 542</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]-&gt;</span>module <span class="hl sym">=</span> <span class="hl kwc">$module</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l543" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l543" class="linenr"> 543</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]-&gt;</span>pool <span class="hl sym">=</span> <span class="hl kwc">$pool</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l544" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l544" class="linenr"> 544</a> </div>
<div class="pre"><a id="l545" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l545" class="linenr"> 545</a>           <span class="hl slc">// We mark all module defined pools as &quot;new&quot; since we don't know</span></div>
<div class="pre"><a id="l546" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l546" class="linenr"> 546</a>           <span class="hl slc">// which of these pools have already been saved to the database at</span></div>
<div class="pre"><a id="l547" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l547" class="linenr"> 547</a>           <span class="hl slc">// this point.</span></div>
<div class="pre"><a id="l548" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l548" class="linenr"> 548</a>           <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">]-&gt;</span>new <span class="hl sym">=</span> TRUE<span class="hl sym">;</span></div>
<div class="pre"><a id="l549" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l549" class="linenr"> 549</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l550" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l550" class="linenr"> 550</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l551" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l551" class="linenr"> 551</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l552" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l552" class="linenr"> 552</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l553" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l553" class="linenr"> 553</a> </div>
<div class="pre"><a id="l554" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l554" class="linenr"> 554</a>   <span class="hl kwc">$query</span> <span class="hl sym">=</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote_pool'</span><span class="hl sym">,</span> <span class="hl str">'vp'</span><span class="hl sym">)-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'vp'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l555" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l555" class="linenr"> 555</a> </div>
<div class="pre"><a id="l556" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l556" class="linenr"> 556</a>   <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span> as <span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l557" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l557" class="linenr"> 557</a>     <span class="hl kwc">$key</span> <span class="hl sym">=</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">;</span></div>
<div class="pre"><a id="l558" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l558" class="linenr"> 558</a>     <span class="hl kwc">$disabled</span> <span class="hl sym">=</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l559" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l559" class="linenr"> 559</a> </div>
<div class="pre"><a id="l560" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l560" class="linenr"> 560</a>     <span class="hl slc">// If the pool is not a custom pool and is not defined by a module either</span></div>
<div class="pre"><a id="l561" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l561" class="linenr"> 561</a>     <span class="hl slc">// we mark it as disabled. Otherwise we mark it as enabled.</span></div>
<div class="pre"><a id="l562" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l562" class="linenr"> 562</a>     <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>disabled <span class="hl sym">= !</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>custom <span class="hl sym">&amp;&amp;</span> <span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]);</span></div>
<div class="pre"><a id="l563" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l563" class="linenr"> 563</a> </div>
<div class="pre"><a id="l564" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l564" class="linenr"> 564</a>     <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l565" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l565" class="linenr"> 565</a>       <span class="hl slc">// This is a module defined pool that already exists in the database</span></div>
<div class="pre"><a id="l566" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l566" class="linenr"> 566</a>       <span class="hl slc">// so its definitely not new.</span></div>
<div class="pre"><a id="l567" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l567" class="linenr"> 567</a>       <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>new <span class="hl sym">=</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l568" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l568" class="linenr"> 568</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l569" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l569" class="linenr"> 569</a> </div>
<div class="pre"><a id="l570" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l570" class="linenr"> 570</a>     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]) ||</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>modified<span class="hl sym">) {</span></div>
<div class="pre"><a id="l571" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l571" class="linenr"> 571</a>       <span class="hl slc">// If this pools has not been defined by a module or has been modified</span></div>
<div class="pre"><a id="l572" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l572" class="linenr"> 572</a>       <span class="hl slc">// by an administrator we place it in our actual $pools array and overwrite</span></div>
<div class="pre"><a id="l573" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l573" class="linenr"> 573</a>       <span class="hl slc">// its original representation (if any).</span></div>
<div class="pre"><a id="l574" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l574" class="linenr"> 574</a>       <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">] =</span> <span class="hl kwc">$pool</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l575" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l575" class="linenr"> 575</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l576" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l576" class="linenr"> 576</a> </div>
<div class="pre"><a id="l577" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l577" class="linenr"> 577</a>     <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>disabled <span class="hl sym">=</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l578" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l578" class="linenr"> 578</a>     <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>changed <span class="hl sym">=</span> <span class="hl kwc">$disabled</span> <span class="hl sym">!=</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l579" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l579" class="linenr"> 579</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l580" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l580" class="linenr"> 580</a> </div>
<div class="pre"><a id="l581" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l581" class="linenr"> 581</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$rebuild</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l582" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l582" class="linenr"> 582</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$pools</span> as <span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l583" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l583" class="linenr"> 583</a>       <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>new<span class="hl sym">) || !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>changed<span class="hl sym">)) {</span></div>
<div class="pre"><a id="l584" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l584" class="linenr"> 584</a>         <span class="hl kwd">vote_pool_save</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l585" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l585" class="linenr"> 585</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l586" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l586" class="linenr"> 586</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l587" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l587" class="linenr"> 587</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l588" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l588" class="linenr"> 588</a> </div>
<div class="pre"><a id="l589" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l589" class="linenr"> 589</a>   <span class="hl kwa">return</span> <span class="hl kwc">$pools</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l590" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l590" class="linenr"> 590</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l591" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l591" class="linenr"> 591</a> </div>
<div class="pre"><a id="l592" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l592" class="linenr"> 592</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l593" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l593" class="linenr"> 593</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l594" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l594" class="linenr"> 594</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l595" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l595" class="linenr"> 595</a> <span class="hl kwa">function</span> <span class="hl kwd">_vote_aggregate_info_build</span><span class="hl sym">(</span><span class="hl kwc">$rebuild</span> <span class="hl sym">=</span> FALSE<span class="hl sym">) {</span></div>
<div class="pre"><a id="l596" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l596" class="linenr"> 596</a>   <span class="hl kwc">$aggregates</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l597" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l597" class="linenr"> 597</a> </div>
<div class="pre"><a id="l598" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l598" class="linenr"> 598</a>   <span class="hl slc">// Collect module defined vote aggregates.</span></div>
<div class="pre"><a id="l599" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l599" class="linenr"> 599</a>   <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwd">module_implements</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate_info'</span><span class="hl sym">)</span> as <span class="hl kwc">$module</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l600" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l600" class="linenr"> 600</a>     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> <span class="hl sym">=</span> <span class="hl kwd">module_invoke</span><span class="hl sym">(</span><span class="hl kwc">$module</span><span class="hl sym">,</span> <span class="hl str">'vote_aggregate_info'</span><span class="hl sym">)) {</span></div>
<div class="pre"><a id="l601" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l601" class="linenr"> 601</a>       <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$data</span> as <span class="hl kwc">$aggregate</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$info</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l602" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l602" class="linenr"> 602</a>         <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$type</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">[</span><span class="hl str">'type'</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l603" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l603" class="linenr"> 603</a>           <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$aggregate</span><span class="hl sym">] =</span> <span class="hl kwd">vote_aggregate_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$info</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l604" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l604" class="linenr"> 604</a>           <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$aggregate</span><span class="hl sym">]-&gt;</span>module <span class="hl sym">=</span> <span class="hl kwc">$module</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l605" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l605" class="linenr"> 605</a>           <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$aggregate</span><span class="hl sym">]-&gt;</span>aggregate <span class="hl sym">=</span> <span class="hl kwc">$aggregate</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l606" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l606" class="linenr"> 606</a>         <span class="hl sym">}</span></div>
<div class="pre"><a id="l607" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l607" class="linenr"> 607</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l608" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l608" class="linenr"> 608</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l609" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l609" class="linenr"> 609</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l610" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l610" class="linenr"> 610</a> </div>
<div class="pre"><a id="l611" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l611" class="linenr"> 611</a>   <span class="hl kwc">$query</span> <span class="hl sym">=</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate'</span><span class="hl sym">,</span> <span class="hl str">'va'</span><span class="hl sym">)-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl str">'va'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l612" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l612" class="linenr"> 612</a> </div>
<div class="pre"><a id="l613" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l613" class="linenr"> 613</a>   <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$query</span><span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span> as <span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l614" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l614" class="linenr"> 614</a>     <span class="hl kwc">$key</span> <span class="hl sym">=</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">;</span></div>
<div class="pre"><a id="l615" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l615" class="linenr"> 615</a>     <span class="hl kwc">$disabled</span> <span class="hl sym">=</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l616" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l616" class="linenr"> 616</a> </div>
<div class="pre"><a id="l617" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l617" class="linenr"> 617</a>     <span class="hl slc">// If the aggregate is not a custom aggregate and is not defined by a module either</span></div>
<div class="pre"><a id="l618" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l618" class="linenr"> 618</a>     <span class="hl slc">// we mark it as disabled. Otherwise we mark it as enabled.</span></div>
<div class="pre"><a id="l619" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l619" class="linenr"> 619</a>     <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>disabled <span class="hl sym">= !</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>custom <span class="hl sym">&amp;&amp;</span> <span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]);</span></div>
<div class="pre"><a id="l620" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l620" class="linenr"> 620</a> </div>
<div class="pre"><a id="l621" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l621" class="linenr"> 621</a>     <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">])) {</span></div>
<div class="pre"><a id="l622" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l622" class="linenr"> 622</a>       <span class="hl slc">// This is a module defined aggregate that already exists in the database</span></div>
<div class="pre"><a id="l623" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l623" class="linenr"> 623</a>       <span class="hl slc">// so its definitely not new.</span></div>
<div class="pre"><a id="l624" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l624" class="linenr"> 624</a>       <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>new <span class="hl sym">=</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l625" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l625" class="linenr"> 625</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l626" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l626" class="linenr"> 626</a> </div>
<div class="pre"><a id="l627" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l627" class="linenr"> 627</a>     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]) ||</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>modified<span class="hl sym">) {</span></div>
<div class="pre"><a id="l628" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l628" class="linenr"> 628</a>       <span class="hl slc">// If this aggregates has not been defined by a module or has been modified</span></div>
<div class="pre"><a id="l629" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l629" class="linenr"> 629</a>       <span class="hl slc">// by an administrator we place it in our actual $aggregates array and overwrite</span></div>
<div class="pre"><a id="l630" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l630" class="linenr"> 630</a>       <span class="hl slc">// its original representation (if any).</span></div>
<div class="pre"><a id="l631" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l631" class="linenr"> 631</a>       <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">] =</span> <span class="hl kwc">$aggregate</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l632" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l632" class="linenr"> 632</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l633" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l633" class="linenr"> 633</a> </div>
<div class="pre"><a id="l634" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l634" class="linenr"> 634</a>     <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>disabled <span class="hl sym">=</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l635" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l635" class="linenr"> 635</a>     <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$key</span><span class="hl sym">]-&gt;</span>changed <span class="hl sym">=</span> <span class="hl kwc">$disabled</span> <span class="hl sym">!=</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">;</span></div>
<div class="pre"><a id="l636" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l636" class="linenr"> 636</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l637" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l637" class="linenr"> 637</a> </div>
<div class="pre"><a id="l638" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l638" class="linenr"> 638</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$rebuild</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l639" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l639" class="linenr"> 639</a>     <span class="hl kwa">foreach</span> <span class="hl sym">(</span><span class="hl kwc">$aggregates</span> as <span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l640" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l640" class="linenr"> 640</a>       <span class="hl kwa">if</span> <span class="hl sym">(!</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>new<span class="hl sym">) || !</span><span class="hl kwd">empty</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>changed<span class="hl sym">)) {</span></div>
<div class="pre"><a id="l641" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l641" class="linenr"> 641</a>         <span class="hl kwd">vote_aggregate_save</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l642" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l642" class="linenr"> 642</a>       <span class="hl sym">}</span></div>
<div class="pre"><a id="l643" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l643" class="linenr"> 643</a>     <span class="hl sym">}</span></div>
<div class="pre"><a id="l644" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l644" class="linenr"> 644</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l645" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l645" class="linenr"> 645</a> </div>
<div class="pre"><a id="l646" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l646" class="linenr"> 646</a>   <span class="hl kwa">return</span> <span class="hl kwc">$aggregates</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l647" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l647" class="linenr"> 647</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l648" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l648" class="linenr"> 648</a> </div>
<div class="pre"><a id="l649" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l649" class="linenr"> 649</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l650" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l650" class="linenr"> 650</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l651" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l651" class="linenr"> 651</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l652" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l652" class="linenr"> 652</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_pool_get_pools</span><span class="hl sym">() {</span></div>
<div class="pre"><a id="l653" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l653" class="linenr"> 653</a>   <span class="hl kwa">return</span> <span class="hl kwd">_vote_bundles_build</span><span class="hl sym">()-&gt;</span>pools<span class="hl sym">;</span></div>
<div class="pre"><a id="l654" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l654" class="linenr"> 654</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l655" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l655" class="linenr"> 655</a> </div>
<div class="pre"><a id="l656" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l656" class="linenr"> 656</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l657" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l657" class="linenr"> 657</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l658" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l658" class="linenr"> 658</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l659" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l659" class="linenr"> 659</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_pool_get_pool</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l660" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l660" class="linenr"> 660</a>   <span class="hl kwc">$pools</span> <span class="hl sym">=</span> <span class="hl kwd">_vote_bundles_build</span><span class="hl sym">()-&gt;</span>pools<span class="hl sym">;</span></div>
<div class="pre"><a id="l661" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l661" class="linenr"> 661</a> </div>
<div class="pre"><a id="l662" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l662" class="linenr"> 662</a>   <span class="hl kwa">return</span> <span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">])</span> ? <span class="hl kwc">$pools</span><span class="hl sym">[</span><span class="hl kwc">$pool</span><span class="hl sym">] :</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l663" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l663" class="linenr"> 663</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l664" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l664" class="linenr"> 664</a> </div>
<div class="pre"><a id="l665" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l665" class="linenr"> 665</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l666" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l666" class="linenr"> 666</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l667" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l667" class="linenr"> 667</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l668" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l668" class="linenr"> 668</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_aggregate_get_aggregates</span><span class="hl sym">() {</span></div>
<div class="pre"><a id="l669" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l669" class="linenr"> 669</a>   <span class="hl kwa">return</span> <span class="hl kwd">_vote_bundles_build</span><span class="hl sym">()-&gt;</span>aggregates<span class="hl sym">;</span></div>
<div class="pre"><a id="l670" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l670" class="linenr"> 670</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l671" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l671" class="linenr"> 671</a> </div>
<div class="pre"><a id="l672" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l672" class="linenr"> 672</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l673" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l673" class="linenr"> 673</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l674" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l674" class="linenr"> 674</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l675" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l675" class="linenr"> 675</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_aggregate_get_aggregate</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l676" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l676" class="linenr"> 676</a>   <span class="hl kwc">$aggregates</span> <span class="hl sym">=</span> <span class="hl kwd">_vote_bundles_build</span><span class="hl sym">()-&gt;</span>aggregates<span class="hl sym">;</span></div>
<div class="pre"><a id="l677" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l677" class="linenr"> 677</a> </div>
<div class="pre"><a id="l678" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l678" class="linenr"> 678</a>   <span class="hl kwa">return</span> <span class="hl kwd">isset</span><span class="hl sym">(</span><span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$aggregate</span><span class="hl sym">])</span> ? <span class="hl kwc">$aggregates</span><span class="hl sym">[</span><span class="hl kwc">$aggregate</span><span class="hl sym">] :</span> FALSE<span class="hl sym">;</span></div>
<div class="pre"><a id="l679" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l679" class="linenr"> 679</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l680" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l680" class="linenr"> 680</a> </div>
<div class="pre"><a id="l681" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l681" class="linenr"> 681</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l682" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l682" class="linenr"> 682</a> <span class="hl com"> * Sets the default values for a voting pool.</span></div>
<div class="pre"><a id="l683" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l683" class="linenr"> 683</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l684" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l684" class="linenr"> 684</a> <span class="hl com"> * &#64;param $pool</span></div>
<div class="pre"><a id="l685" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l685" class="linenr"> 685</a> <span class="hl com"> *   An object or array containing values to override the defaults.</span></div>
<div class="pre"><a id="l686" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l686" class="linenr"> 686</a> <span class="hl com"> *   See hook_vote_pool_info() for details on what the array elements mean.</span></div>
<div class="pre"><a id="l687" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l687" class="linenr"> 687</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l688" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l688" class="linenr"> 688</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l689" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l689" class="linenr"> 689</a> <span class="hl com"> *   A voting pool object, with missing values in $pool set to their defaults.</span></div>
<div class="pre"><a id="l690" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l690" class="linenr"> 690</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l691" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l691" class="linenr"> 691</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_pool_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l692" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l692" class="linenr"> 692</a>   <span class="hl kwc">$pool</span> <span class="hl sym">= ((</span><span class="hl kwa">array</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span> <span class="hl sym">+</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l693" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l693" class="linenr"> 693</a>     <span class="hl str">'pool'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l694" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l694" class="linenr"> 694</a>     <span class="hl str">'name'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l695" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l695" class="linenr"> 695</a>     <span class="hl str">'module'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l696" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l696" class="linenr"> 696</a>     <span class="hl str">'description'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l697" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l697" class="linenr"> 697</a>     <span class="hl str">'settings'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">array</span><span class="hl sym">(),</span></div>
<div class="pre"><a id="l698" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l698" class="linenr"> 698</a>     <span class="hl str">'custom'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l699" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l699" class="linenr"> 699</a>     <span class="hl str">'modified'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l700" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l700" class="linenr"> 700</a>     <span class="hl str">'locked'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l701" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l701" class="linenr"> 701</a>     <span class="hl str">'disabled'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l702" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l702" class="linenr"> 702</a>   <span class="hl sym">));</span></div>
<div class="pre"><a id="l703" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l703" class="linenr"> 703</a> </div>
<div class="pre"><a id="l704" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l704" class="linenr"> 704</a>   <span class="hl kwc">$type</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">[</span><span class="hl str">'type'</span><span class="hl sym">]);</span></div>
<div class="pre"><a id="l705" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l705" class="linenr"> 705</a> </div>
<div class="pre"><a id="l706" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l706" class="linenr"> 706</a>   <span class="hl slc">// Also populate the settings array with some defaults.</span></div>
<div class="pre"><a id="l707" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l707" class="linenr"> 707</a>   <span class="hl kwc">$pool</span><span class="hl sym">[</span><span class="hl str">'settings'</span><span class="hl sym">] +=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l708" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l708" class="linenr"> 708</a>     <span class="hl str">'functions'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$type</span><span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">],</span></div>
<div class="pre"><a id="l709" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l709" class="linenr"> 709</a>     <span class="hl str">'queue'</span> <span class="hl sym">=&gt;</span> TRUE<span class="hl sym">,</span></div>
<div class="pre"><a id="l710" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l710" class="linenr"> 710</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l711" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l711" class="linenr"> 711</a> </div>
<div class="pre"><a id="l712" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l712" class="linenr"> 712</a>   <span class="hl kwa">return</span> <span class="hl sym">(</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l713" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l713" class="linenr"> 713</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l714" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l714" class="linenr"> 714</a> </div>
<div class="pre"><a id="l715" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l715" class="linenr"> 715</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l716" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l716" class="linenr"> 716</a> <span class="hl com"> * Sets the default values for a voting pool.</span></div>
<div class="pre"><a id="l717" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l717" class="linenr"> 717</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l718" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l718" class="linenr"> 718</a> <span class="hl com"> * &#64;param $aggregate</span></div>
<div class="pre"><a id="l719" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l719" class="linenr"> 719</a> <span class="hl com"> *   An object or array containing values to override the defaults.</span></div>
<div class="pre"><a id="l720" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l720" class="linenr"> 720</a> <span class="hl com"> *   See hook_vote_aggregate_info() for details on what the array elements mean.</span></div>
<div class="pre"><a id="l721" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l721" class="linenr"> 721</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l722" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l722" class="linenr"> 722</a> <span class="hl com"> * &#64;return</span></div>
<div class="pre"><a id="l723" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l723" class="linenr"> 723</a> <span class="hl com"> *   A aggregate object, with missing values in $aggregate set to their defaults.</span></div>
<div class="pre"><a id="l724" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l724" class="linenr"> 724</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l725" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l725" class="linenr"> 725</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_aggregate_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l726" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l726" class="linenr"> 726</a>   <span class="hl slc">// Typecast $aggregate to be an array so we can easily populate that array</span></div>
<div class="pre"><a id="l727" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l727" class="linenr"> 727</a>   <span class="hl slc">// with some default values in the next step.</span></div>
<div class="pre"><a id="l728" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l728" class="linenr"> 728</a>   <span class="hl kwc">$aggregate</span> <span class="hl sym">= (</span><span class="hl kwa">array</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span> <span class="hl sym">+</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l729" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l729" class="linenr"> 729</a>     <span class="hl str">'aggregate'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l730" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l730" class="linenr"> 730</a>     <span class="hl str">'name'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l731" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l731" class="linenr"> 731</a>     <span class="hl str">'module'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l732" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l732" class="linenr"> 732</a>     <span class="hl str">'description'</span> <span class="hl sym">=&gt;</span> <span class="hl str">''</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l733" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l733" class="linenr"> 733</a>     <span class="hl str">'settings'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">array</span><span class="hl sym">(),</span></div>
<div class="pre"><a id="l734" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l734" class="linenr"> 734</a>     <span class="hl str">'custom'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l735" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l735" class="linenr"> 735</a>     <span class="hl str">'modified'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l736" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l736" class="linenr"> 736</a>     <span class="hl str">'locked'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l737" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l737" class="linenr"> 737</a>     <span class="hl str">'disabled'</span> <span class="hl sym">=&gt;</span> <span class="hl num">0</span><span class="hl sym">,</span></div>
<div class="pre"><a id="l738" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l738" class="linenr"> 738</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l739" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l739" class="linenr"> 739</a> </div>
<div class="pre"><a id="l740" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l740" class="linenr"> 740</a>   <span class="hl kwc">$type</span> <span class="hl sym">=</span> <span class="hl kwd">vote_type_info</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">[</span><span class="hl str">'type'</span><span class="hl sym">]);</span></div>
<div class="pre"><a id="l741" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l741" class="linenr"> 741</a> </div>
<div class="pre"><a id="l742" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l742" class="linenr"> 742</a>   <span class="hl slc">// Also populate the settings array with some defaults.</span></div>
<div class="pre"><a id="l743" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l743" class="linenr"> 743</a>   <span class="hl kwc">$aggregate</span><span class="hl sym">[</span><span class="hl str">'settings'</span><span class="hl sym">] +=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l744" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l744" class="linenr"> 744</a>     <span class="hl str">'pools'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">array</span><span class="hl sym">(),</span></div>
<div class="pre"><a id="l745" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l745" class="linenr"> 745</a>     <span class="hl str">'functions'</span> <span class="hl sym">=&gt;</span> <span class="hl kwc">$type</span><span class="hl sym">[</span><span class="hl str">'functions'</span><span class="hl sym">],</span></div>
<div class="pre"><a id="l746" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l746" class="linenr"> 746</a>     <span class="hl str">'queue'</span> <span class="hl sym">=&gt;</span> TRUE<span class="hl sym">,</span></div>
<div class="pre"><a id="l747" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l747" class="linenr"> 747</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l748" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l748" class="linenr"> 748</a> </div>
<div class="pre"><a id="l749" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l749" class="linenr"> 749</a>   <span class="hl kwa">return</span> <span class="hl sym">(</span><span class="hl kwb">object</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l750" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l750" class="linenr"> 750</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l751" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l751" class="linenr"> 751</a> </div>
<div class="pre"><a id="l752" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l752" class="linenr"> 752</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l753" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l753" class="linenr"> 753</a> <span class="hl com"> * Saves a node type to the database.</span></div>
<div class="pre"><a id="l754" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l754" class="linenr"> 754</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l755" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l755" class="linenr"> 755</a> <span class="hl com"> * &#64;param $pool</span></div>
<div class="pre"><a id="l756" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l756" class="linenr"> 756</a> <span class="hl com"> *   The voting pool to save, as an object.</span></div>
<div class="pre"><a id="l757" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l757" class="linenr"> 757</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l758" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l758" class="linenr"> 758</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_pool_save</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l759" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l759" class="linenr"> 759</a>   <span class="hl slc">// First, figure out wether we need to update an existing pool or insert a new</span></div>
<div class="pre"><a id="l760" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l760" class="linenr"> 760</a>   <span class="hl slc">// one. So... Does the $pool-&gt;type already exist?</span></div>
<div class="pre"><a id="l761" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l761" class="linenr"> 761</a>   <span class="hl kwc">$exists</span> <span class="hl sym">= (</span>bool<span class="hl sym">)</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote_pool'</span><span class="hl sym">,</span> <span class="hl str">'vp'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l762" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l762" class="linenr"> 762</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">)</span></div>
<div class="pre"><a id="l763" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l763" class="linenr"> 763</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">countQuery</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l764" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l764" class="linenr"> 764</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l765" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l765" class="linenr"> 765</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">fetchField</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l766" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l766" class="linenr"> 766</a> </div>
<div class="pre"><a id="l767" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l767" class="linenr"> 767</a>   <span class="hl kwc">$operation</span> <span class="hl sym">=</span> <span class="hl kwc">$exists</span> ? <span class="hl str">'update'</span> <span class="hl sym">:</span> <span class="hl str">'insert'</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l768" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l768" class="linenr"> 768</a> </div>
<div class="pre"><a id="l769" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l769" class="linenr"> 769</a>   <span class="hl slc">// Populate the $pool with some default values if those are not set.</span></div>
<div class="pre"><a id="l770" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l770" class="linenr"> 770</a>   <span class="hl kwc">$pool</span> <span class="hl sym">=</span> <span class="hl kwd">vote_pool_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l771" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l771" class="linenr"> 771</a> </div>
<div class="pre"><a id="l772" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l772" class="linenr"> 772</a>   <span class="hl kwc">$fields</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l773" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l773" class="linenr"> 773</a>     <span class="hl str">'pool'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">,</span></div>
<div class="pre"><a id="l774" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l774" class="linenr"> 774</a>     <span class="hl str">'name'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>name<span class="hl sym">,</span></div>
<div class="pre"><a id="l775" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l775" class="linenr"> 775</a>     <span class="hl str">'description'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>description<span class="hl sym">,</span></div>
<div class="pre"><a id="l776" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l776" class="linenr"> 776</a>     <span class="hl str">'custom'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>custom<span class="hl sym">,</span></div>
<div class="pre"><a id="l777" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l777" class="linenr"> 777</a>     <span class="hl str">'modified'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>modified<span class="hl sym">,</span></div>
<div class="pre"><a id="l778" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l778" class="linenr"> 778</a>     <span class="hl str">'locked'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>locked<span class="hl sym">,</span></div>
<div class="pre"><a id="l779" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l779" class="linenr"> 779</a>     <span class="hl str">'disabled'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">,</span></div>
<div class="pre"><a id="l780" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l780" class="linenr"> 780</a>     <span class="hl str">'module'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>module<span class="hl sym">,</span></div>
<div class="pre"><a id="l781" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l781" class="linenr"> 781</a>     <span class="hl str">'settings'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">serialize</span><span class="hl sym">(</span><span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">),</span></div>
<div class="pre"><a id="l782" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l782" class="linenr"> 782</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l783" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l783" class="linenr"> 783</a> </div>
<div class="pre"><a id="l784" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l784" class="linenr"> 784</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$operation</span> <span class="hl sym">==</span> <span class="hl str">'update'</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l785" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l785" class="linenr"> 785</a>     <span class="hl kwd">db_update</span><span class="hl sym">(</span><span class="hl str">'vote_pool'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l786" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l786" class="linenr"> 786</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l787" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l787" class="linenr"> 787</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">)</span></div>
<div class="pre"><a id="l788" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l788" class="linenr"> 788</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l789" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l789" class="linenr"> 789</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l790" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l790" class="linenr"> 790</a>   <span class="hl kwa">else</span> <span class="hl sym">{</span></div>
<div class="pre"><a id="l791" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l791" class="linenr"> 791</a>     <span class="hl kwd">db_insert</span><span class="hl sym">(</span><span class="hl str">'vote_pool'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l792" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l792" class="linenr"> 792</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l793" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l793" class="linenr"> 793</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l794" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l794" class="linenr"> 794</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l795" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l795" class="linenr"> 795</a> </div>
<div class="pre"><a id="l796" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l796" class="linenr"> 796</a>   <span class="hl slc">// Inform other modules about the update / insert.</span></div>
<div class="pre"><a id="l797" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l797" class="linenr"> 797</a>   <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_pool_'</span> . <span class="hl kwc">$operation</span><span class="hl sym">,</span> <span class="hl kwc">$pool</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l798" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l798" class="linenr"> 798</a> </div>
<div class="pre"><a id="l799" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l799" class="linenr"> 799</a>   <span class="hl slc">// Clear the cache.</span></div>
<div class="pre"><a id="l800" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l800" class="linenr"> 800</a>   <span class="hl kwd">vote_bundle_cache_reset</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l801" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l801" class="linenr"> 801</a> </div>
<div class="pre"><a id="l802" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l802" class="linenr"> 802</a>   <span class="hl kwa">return</span> <span class="hl kwc">$operation</span> <span class="hl sym">==</span> <span class="hl str">'update'</span> ? SAVED_UPDATED <span class="hl sym">:</span> SAVED_NEW<span class="hl sym">;</span></div>
<div class="pre"><a id="l803" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l803" class="linenr"> 803</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l804" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l804" class="linenr"> 804</a> </div>
<div class="pre"><a id="l805" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l805" class="linenr"> 805</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l806" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l806" class="linenr"> 806</a> <span class="hl com"> * Deletes a voting pool from the database.</span></div>
<div class="pre"><a id="l807" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l807" class="linenr"> 807</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l808" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l808" class="linenr"> 808</a> <span class="hl com"> * &#64;param $name</span></div>
<div class="pre"><a id="l809" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l809" class="linenr"> 809</a> <span class="hl com"> *   The machine-readable name of the voting pool to be deleted.</span></div>
<div class="pre"><a id="l810" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l810" class="linenr"> 810</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l811" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l811" class="linenr"> 811</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_pool_delete</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l812" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l812" class="linenr"> 812</a>   <span class="hl slc">// Delete the pool itself.</span></div>
<div class="pre"><a id="l813" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l813" class="linenr"> 813</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_pool'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l814" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l814" class="linenr"> 814</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l815" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l815" class="linenr"> 815</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l816" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l816" class="linenr"> 816</a> </div>
<div class="pre"><a id="l817" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l817" class="linenr"> 817</a>   <span class="hl slc">// Delete all votes and vote results in the pool.</span></div>
<div class="pre"><a id="l818" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l818" class="linenr"> 818</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l819" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l819" class="linenr"> 819</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l820" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l820" class="linenr"> 820</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l821" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l821" class="linenr"> 821</a> </div>
<div class="pre"><a id="l822" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l822" class="linenr"> 822</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l823" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l823" class="linenr"> 823</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l824" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l824" class="linenr"> 824</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l825" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l825" class="linenr"> 825</a> </div>
<div class="pre"><a id="l826" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l826" class="linenr"> 826</a>   <span class="hl slc">// Normally we would not have to flush the queue but since this function</span></div>
<div class="pre"><a id="l827" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l827" class="linenr"> 827</a>   <span class="hl slc">// is being used so rarely we can afford doing it here.</span></div>
<div class="pre"><a id="l828" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l828" class="linenr"> 828</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_queue'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l829" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l829" class="linenr"> 829</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l830" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l830" class="linenr"> 830</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l831" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l831" class="linenr"> 831</a> </div>
<div class="pre"><a id="l832" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l832" class="linenr"> 832</a>   <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_pool_delete'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l833" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l833" class="linenr"> 833</a> </div>
<div class="pre"><a id="l834" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l834" class="linenr"> 834</a>   <span class="hl slc">// Clear the pool and the aggregate cache.</span></div>
<div class="pre"><a id="l835" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l835" class="linenr"> 835</a>   <span class="hl kwd">vote_bundle_cache_reset</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l836" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l836" class="linenr"> 836</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l837" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l837" class="linenr"> 837</a> </div>
<div class="pre"><a id="l838" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l838" class="linenr"> 838</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l839" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l839" class="linenr"> 839</a> <span class="hl com"> * Saves am aggregate to the database.</span></div>
<div class="pre"><a id="l840" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l840" class="linenr"> 840</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l841" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l841" class="linenr"> 841</a> <span class="hl com"> * &#64;param $info</span></div>
<div class="pre"><a id="l842" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l842" class="linenr"> 842</a> <span class="hl com"> *   The voting aggregate to save, as an object.</span></div>
<div class="pre"><a id="l843" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l843" class="linenr"> 843</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l844" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l844" class="linenr"> 844</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_aggregate_save</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l845" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l845" class="linenr"> 845</a>   <span class="hl slc">// First, figure out wether we need to update an existing pool or insert a new</span></div>
<div class="pre"><a id="l846" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l846" class="linenr"> 846</a>   <span class="hl slc">// one. So... Does the $pool-&gt;type already exist?</span></div>
<div class="pre"><a id="l847" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l847" class="linenr"> 847</a>   <span class="hl kwc">$exists</span> <span class="hl sym">= (</span>bool<span class="hl sym">)</span> <span class="hl kwd">db_select</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate'</span><span class="hl sym">,</span> <span class="hl str">'va'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l848" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l848" class="linenr"> 848</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">)</span></div>
<div class="pre"><a id="l849" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l849" class="linenr"> 849</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">countQuery</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l850" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l850" class="linenr"> 850</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">()</span></div>
<div class="pre"><a id="l851" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l851" class="linenr"> 851</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">fetchField</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l852" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l852" class="linenr"> 852</a> </div>
<div class="pre"><a id="l853" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l853" class="linenr"> 853</a>   <span class="hl kwc">$operation</span> <span class="hl sym">=</span> <span class="hl kwc">$exists</span> ? <span class="hl str">'update'</span> <span class="hl sym">:</span> <span class="hl str">'insert'</span><span class="hl sym">;</span></div>
<div class="pre"><a id="l854" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l854" class="linenr"> 854</a> </div>
<div class="pre"><a id="l855" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l855" class="linenr"> 855</a>   <span class="hl slc">// Populate the $pool with some default values if those are not set.</span></div>
<div class="pre"><a id="l856" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l856" class="linenr"> 856</a>   <span class="hl kwc">$aggregate</span> <span class="hl sym">=</span> <span class="hl kwd">vote_aggregate_set_defaults</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l857" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l857" class="linenr"> 857</a> </div>
<div class="pre"><a id="l858" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l858" class="linenr"> 858</a>   <span class="hl kwc">$fields</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span></div>
<div class="pre"><a id="l859" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l859" class="linenr"> 859</a>     <span class="hl str">'pool'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">,</span></div>
<div class="pre"><a id="l860" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l860" class="linenr"> 860</a>     <span class="hl str">'name'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>name<span class="hl sym">,</span></div>
<div class="pre"><a id="l861" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l861" class="linenr"> 861</a>     <span class="hl str">'description'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>description<span class="hl sym">,</span></div>
<div class="pre"><a id="l862" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l862" class="linenr"> 862</a>     <span class="hl str">'custom'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>custom<span class="hl sym">,</span></div>
<div class="pre"><a id="l863" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l863" class="linenr"> 863</a>     <span class="hl str">'modified'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>modified<span class="hl sym">,</span></div>
<div class="pre"><a id="l864" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l864" class="linenr"> 864</a>     <span class="hl str">'locked'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>locked<span class="hl sym">,</span></div>
<div class="pre"><a id="l865" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l865" class="linenr"> 865</a>     <span class="hl str">'disabled'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">int</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>disabled<span class="hl sym">,</span></div>
<div class="pre"><a id="l866" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l866" class="linenr"> 866</a>     <span class="hl str">'module'</span> <span class="hl sym">=&gt; (</span><span class="hl kwb">string</span><span class="hl sym">)</span> <span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>module<span class="hl sym">,</span></div>
<div class="pre"><a id="l867" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l867" class="linenr"> 867</a>     <span class="hl str">'settings'</span> <span class="hl sym">=&gt;</span> <span class="hl kwa">serialize</span><span class="hl sym">(</span><span class="hl kwc">$aggregate</span><span class="hl sym">-&gt;</span>settings<span class="hl sym">),</span></div>
<div class="pre"><a id="l868" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l868" class="linenr"> 868</a>   <span class="hl sym">);</span></div>
<div class="pre"><a id="l869" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l869" class="linenr"> 869</a> </div>
<div class="pre"><a id="l870" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l870" class="linenr"> 870</a>   <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwc">$operation</span> <span class="hl sym">==</span> <span class="hl str">'update'</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l871" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l871" class="linenr"> 871</a>     <span class="hl kwd">db_update</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l872" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l872" class="linenr"> 872</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l873" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l873" class="linenr"> 873</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'pool'</span><span class="hl sym">,</span> <span class="hl kwc">$pool</span><span class="hl sym">-&gt;</span>pool<span class="hl sym">)</span></div>
<div class="pre"><a id="l874" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l874" class="linenr"> 874</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l875" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l875" class="linenr"> 875</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l876" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l876" class="linenr"> 876</a>   <span class="hl kwa">else</span> <span class="hl sym">{</span></div>
<div class="pre"><a id="l877" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l877" class="linenr"> 877</a>     <span class="hl kwd">db_insert</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l878" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l878" class="linenr"> 878</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">fields</span><span class="hl sym">(</span><span class="hl kwc">$fields</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l879" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l879" class="linenr"> 879</a>       <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l880" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l880" class="linenr"> 880</a>   <span class="hl sym">}</span></div>
<div class="pre"><a id="l881" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l881" class="linenr"> 881</a> </div>
<div class="pre"><a id="l882" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l882" class="linenr"> 882</a>   <span class="hl slc">// Inform other modules about the update / insert.</span></div>
<div class="pre"><a id="l883" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l883" class="linenr"> 883</a>   <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate_'</span> . <span class="hl kwc">$operation</span><span class="hl sym">,</span> <span class="hl kwc">$aggregate</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l884" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l884" class="linenr"> 884</a> </div>
<div class="pre"><a id="l885" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l885" class="linenr"> 885</a>   <span class="hl slc">// Clear the cache.</span></div>
<div class="pre"><a id="l886" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l886" class="linenr"> 886</a>   <span class="hl kwd">vote_bundle_cache_reset</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l887" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l887" class="linenr"> 887</a> </div>
<div class="pre"><a id="l888" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l888" class="linenr"> 888</a>   <span class="hl kwa">return</span> <span class="hl kwc">$operation</span> <span class="hl sym">==</span> <span class="hl str">'update'</span> ? SAVED_UPDATED <span class="hl sym">:</span> SAVED_NEW<span class="hl sym">;</span></div>
<div class="pre"><a id="l889" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l889" class="linenr"> 889</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l890" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l890" class="linenr"> 890</a> </div>
<div class="pre"><a id="l891" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l891" class="linenr"> 891</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l892" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l892" class="linenr"> 892</a> <span class="hl com"> * Deletes an aggregate from the database.</span></div>
<div class="pre"><a id="l893" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l893" class="linenr"> 893</a> <span class="hl com"> *</span></div>
<div class="pre"><a id="l894" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l894" class="linenr"> 894</a> <span class="hl com"> * &#64;param $name</span></div>
<div class="pre"><a id="l895" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l895" class="linenr"> 895</a> <span class="hl com"> *   The machine-readable name of the aggregate to be deleted.</span></div>
<div class="pre"><a id="l896" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l896" class="linenr"> 896</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l897" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l897" class="linenr"> 897</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_aggregate_delete</span><span class="hl sym">(</span><span class="hl kwc">$name</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l898" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l898" class="linenr"> 898</a>   <span class="hl slc">// Delete the aggregate itself.</span></div>
<div class="pre"><a id="l899" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l899" class="linenr"> 899</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l900" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l900" class="linenr"> 900</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'aggregate'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l901" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l901" class="linenr"> 901</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l902" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l902" class="linenr"> 902</a> </div>
<div class="pre"><a id="l903" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l903" class="linenr"> 903</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_result'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l904" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l904" class="linenr"> 904</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'bundle'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l905" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l905" class="linenr"> 905</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'aggregate'</span><span class="hl sym">,</span> TRUE<span class="hl sym">)</span></div>
<div class="pre"><a id="l906" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l906" class="linenr"> 906</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l907" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l907" class="linenr"> 907</a> </div>
<div class="pre"><a id="l908" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l908" class="linenr"> 908</a>   <span class="hl slc">// Normally we would not have to flush the queue but since this function</span></div>
<div class="pre"><a id="l909" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l909" class="linenr"> 909</a>   <span class="hl slc">// is being used so rarely we can afford doing it here.</span></div>
<div class="pre"><a id="l910" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l910" class="linenr"> 910</a>   <span class="hl kwd">db_delete</span><span class="hl sym">(</span><span class="hl str">'vote_queue'</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l911" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l911" class="linenr"> 911</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'bundle'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">)</span></div>
<div class="pre"><a id="l912" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l912" class="linenr"> 912</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">condition</span><span class="hl sym">(</span><span class="hl str">'aggregate'</span><span class="hl sym">,</span> TRUE<span class="hl sym">)</span></div>
<div class="pre"><a id="l913" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l913" class="linenr"> 913</a>     <span class="hl sym">-&gt;</span><span class="hl kwd">execute</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l914" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l914" class="linenr"> 914</a> </div>
<div class="pre"><a id="l915" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l915" class="linenr"> 915</a>   <span class="hl kwd">module_invoke_all</span><span class="hl sym">(</span><span class="hl str">'vote_aggregate_delete'</span><span class="hl sym">,</span> <span class="hl kwc">$name</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l916" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l916" class="linenr"> 916</a> </div>
<div class="pre"><a id="l917" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l917" class="linenr"> 917</a>   <span class="hl slc">// Clear the aggregate and the pool cache.</span></div>
<div class="pre"><a id="l918" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l918" class="linenr"> 918</a>   <span class="hl kwd">vote_bundle_cache_reset</span><span class="hl sym">();</span></div>
<div class="pre"><a id="l919" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l919" class="linenr"> 919</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l920" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l920" class="linenr"> 920</a> </div>
<div class="pre"><a id="l921" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l921" class="linenr"> 921</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l922" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l922" class="linenr"> 922</a> <span class="hl com"> * Clears the voting bundles cache.</span></div>
<div class="pre"><a id="l923" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l923" class="linenr"> 923</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l924" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l924" class="linenr"> 924</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_bundle_cache_reset</span><span class="hl sym">() {</span></div>
<div class="pre"><a id="l925" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l925" class="linenr"> 925</a>   <span class="hl kwd">drupal_static_reset</span><span class="hl sym">(</span><span class="hl str">'_vote_bundle_build'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l926" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l926" class="linenr"> 926</a>   <span class="hl kwd">cache_clear_all</span><span class="hl sym">(</span><span class="hl str">'vote_bundles'</span><span class="hl sym">,</span> <span class="hl str">'cache'</span><span class="hl sym">);</span></div>
<div class="pre"><a id="l927" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l927" class="linenr"> 927</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l928" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l928" class="linenr"> 928</a> </div>
<div class="pre"><a id="l929" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l929" class="linenr"> 929</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l930" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l930" class="linenr"> 930</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l931" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l931" class="linenr"> 931</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l932" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l932" class="linenr"> 932</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_queue_key</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l933" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l933" class="linenr"> 933</a>   <span class="hl kwc">$item</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">);</span></div>
<div class="pre"><a id="l934" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l934" class="linenr"> 934</a> </div>
<div class="pre"><a id="l935" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l935" class="linenr"> 935</a>   <span class="hl kwa">return</span> <span class="hl kwd">hash</span><span class="hl sym">(</span><span class="hl str">'sha256'</span><span class="hl sym">,</span> <span class="hl kwa">serialize</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l936" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l936" class="linenr"> 936</a> <span class="hl sym">}</span></div>
<div class="pre"><a id="l937" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l937" class="linenr"> 937</a> </div>
<div class="pre"><a id="l938" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l938" class="linenr"> 938</a> <span class="hl com">/**</span></div>
<div class="pre"><a id="l939" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l939" class="linenr"> 939</a> <span class="hl com"> * &#64;todo</span></div>
<div class="pre"><a id="l940" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l940" class="linenr"> 940</a> <span class="hl com"> */</span></div>
<div class="pre"><a id="l941" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l941" class="linenr"> 941</a> <span class="hl kwa">function</span> <span class="hl kwd">vote_result_key</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">) {</span></div>
<div class="pre"><a id="l942" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l942" class="linenr"> 942</a>   <span class="hl kwc">$item</span> <span class="hl sym">=</span> <span class="hl kwa">array</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_type<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>entity_id<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>bundle<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>aggregate<span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span><span class="hl kwa">function</span><span class="hl sym">,</span> <span class="hl kwc">$item</span><span class="hl sym">-&gt;</span>delta<span class="hl sym">);</span></div>
<div class="pre"><a id="l943" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l943" class="linenr"> 943</a> </div>
<div class="pre"><a id="l944" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l944" class="linenr"> 944</a>   <span class="hl kwa">return</span> <span class="hl kwd">hash</span><span class="hl sym">(</span><span class="hl str">'sha256'</span><span class="hl sym">,</span> <span class="hl kwa">serialize</span><span class="hl sym">(</span><span class="hl kwc">$item</span><span class="hl sym">));</span></div>
<div class="pre"><a id="l945" href="http://drupalcode.org/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module#l945" class="linenr"> 945</a> <span class="hl sym">}</span></div>
</div><div class="page_footer">
<div class="cachetime">Cache Last Updated: Thu Oct 11 06:23:37 2012 GMT</div>
<!--
	Full URL: |/sandbox/sumsi/1074206.git/blob/HEAD:/vote.module?|
	URL Hash: |07795f18cf716e5dfa0b1f9149b70e95|
-->
<div class="page_footer_text">For more information about this repository, visit the project page at http://drupal.org/sandbox/sumsi/1074206</div>
<a class="rss_logo" title="history of vote.module RSS feed" href="http://drupalcode.org/sandbox/sumsi/1074206.git/rss?f=vote.module">RSS</a>
<a class="rss_logo" title="history of vote.module Atom feed" href="http://drupalcode.org/sandbox/sumsi/1074206.git/atom?f=vote.module">Atom</a>
</div>
<script type="text/javascript" src="/gitweb.js"></script>
</body>
</html>